
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Gotta be SAFE: a new framework for molecular design">
      
      
      
        <link rel="canonical" href="https://github.com/datamol-io/safe/0.1.13/api/safe.html">
      
      
        <link rel="prev" href="../tutorials/extracting-representation-molfeat.html">
      
      
        <link rel="next" href="safe.viz.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>SAFE - SAFE</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#safe-encoder-decoder" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="SAFE" class="md-header__button md-logo" aria-label="SAFE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SAFE
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SAFE
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/datamol-io/safe" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    datamol-io/safe
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="SAFE" class="md-nav__button md-logo" aria-label="SAFE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    SAFE
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/datamol-io/safe" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    datamol-io/safe
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/getting-started.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started with SAFE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/design-with-safe.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Molecular design
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/how-it-works.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How SAFE encoding works?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/extracting-representation-molfeat.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    so really we just need our custom converter
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    SAFE
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="safe.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    SAFE
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#safe-encoder-decoder" class="md-nav__link">
    <span class="md-ellipsis">
      SAFE Encoder-Decoder
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.converter" class="md-nav__link">
    <span class="md-ellipsis">
      converter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter" class="md-nav__link">
    <span class="md-ellipsis">
      SAFEConverter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SAFEConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter.decoder" class="md-nav__link">
    <span class="md-ellipsis">
      decoder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter.encoder" class="md-nav__link">
    <span class="md-ellipsis">
      encoder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter.randomize" class="md-nav__link">
    <span class="md-ellipsis">
      randomize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.converter.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.converter.decode" class="md-nav__link">
    <span class="md-ellipsis">
      decode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe-design" class="md-nav__link">
    <span class="md-ellipsis">
      SAFE Design
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.sample" class="md-nav__link">
    <span class="md-ellipsis">
      sample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign" class="md-nav__link">
    <span class="md-ellipsis">
      SAFEDesign
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SAFEDesign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.__mix_sequences" class="md-nav__link">
    <span class="md-ellipsis">
      __mix_sequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.de_novo_generation" class="md-nav__link">
    <span class="md-ellipsis">
      de_novo_generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.linker_generation" class="md-nav__link">
    <span class="md-ellipsis">
      linker_generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.load_default" class="md-nav__link">
    <span class="md-ellipsis">
      load_default
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.load_from_wandb" class="md-nav__link">
    <span class="md-ellipsis">
      load_from_wandb
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.motif_extension" class="md-nav__link">
    <span class="md-ellipsis">
      motif_extension
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.pattern_decoration" class="md-nav__link">
    <span class="md-ellipsis">
      pattern_decoration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.scaffold_decoration" class="md-nav__link">
    <span class="md-ellipsis">
      scaffold_decoration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.scaffold_morphing" class="md-nav__link">
    <span class="md-ellipsis">
      scaffold_morphing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.super_structure" class="md-nav__link">
    <span class="md-ellipsis">
      super_structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe-tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      SAFE Tokenizer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      tokenizer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter" class="md-nav__link">
    <span class="md-ellipsis">
      SAFESplitter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SAFESplitter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter.detokenize" class="md-nav__link">
    <span class="md-ellipsis">
      detokenize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter.pre_tokenize" class="md-nav__link">
    <span class="md-ellipsis">
      pre_tokenize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter.tokenize" class="md-nav__link">
    <span class="md-ellipsis">
      tokenize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      SAFETokenizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SAFETokenizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.bos_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      bos_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.cls_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      cls_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.eos_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      eos_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.mask_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      mask_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.pad_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      pad_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.sep_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      sep_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.unk_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      unk_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.__getstate__" class="md-nav__link">
    <span class="md-ellipsis">
      __getstate__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.__setstate__" class="md-nav__link">
    <span class="md-ellipsis">
      __setstate__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.decode" class="md-nav__link">
    <span class="md-ellipsis">
      decode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.from_pretrained" class="md-nav__link">
    <span class="md-ellipsis">
      from_pretrained
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.get_pretrained" class="md-nav__link">
    <span class="md-ellipsis">
      get_pretrained
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.push_to_hub" class="md-nav__link">
    <span class="md-ellipsis">
      push_to_hub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.save_pretrained" class="md-nav__link">
    <span class="md-ellipsis">
      save_pretrained
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.set_special_tokens" class="md-nav__link">
    <span class="md-ellipsis">
      set_special_tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.train_from_iterator" class="md-nav__link">
    <span class="md-ellipsis">
      train_from_iterator
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    <span class="md-ellipsis">
      Utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer" class="md-nav__link">
    <span class="md-ellipsis">
      MolSlicer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MolSlicer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer.get_ring_system" class="md-nav__link">
    <span class="md-ellipsis">
      get_ring_system
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer.link_fragments" class="md-nav__link">
    <span class="md-ellipsis">
      link_fragments
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.attr_as" class="md-nav__link">
    <span class="md-ellipsis">
      attr_as
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.compute_side_chains" class="md-nav__link">
    <span class="md-ellipsis">
      compute_side_chains
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.convert_to_safe" class="md-nav__link">
    <span class="md-ellipsis">
      convert_to_safe
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.filter_by_substructure_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      filter_by_substructure_constraints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.find_partition_edges" class="md-nav__link">
    <span class="md-ellipsis">
      find_partition_edges
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.fragment_aware_spliting" class="md-nav__link">
    <span class="md-ellipsis">
      fragment_aware_spliting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.list_individual_attach_points" class="md-nav__link">
    <span class="md-ellipsis">
      list_individual_attach_points
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.mol_partition" class="md-nav__link">
    <span class="md-ellipsis">
      mol_partition
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.standardize_attach" class="md-nav__link">
    <span class="md-ellipsis">
      standardize_attach
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="safe.viz.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visualization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="safe.models.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model training
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../license.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data_license.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data License
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#safe-encoder-decoder" class="md-nav__link">
    <span class="md-ellipsis">
      SAFE Encoder-Decoder
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.converter" class="md-nav__link">
    <span class="md-ellipsis">
      converter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter" class="md-nav__link">
    <span class="md-ellipsis">
      SAFEConverter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SAFEConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter.decoder" class="md-nav__link">
    <span class="md-ellipsis">
      decoder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter.encoder" class="md-nav__link">
    <span class="md-ellipsis">
      encoder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.converter.SAFEConverter.randomize" class="md-nav__link">
    <span class="md-ellipsis">
      randomize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.converter.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.converter.decode" class="md-nav__link">
    <span class="md-ellipsis">
      decode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe-design" class="md-nav__link">
    <span class="md-ellipsis">
      SAFE Design
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.sample" class="md-nav__link">
    <span class="md-ellipsis">
      sample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign" class="md-nav__link">
    <span class="md-ellipsis">
      SAFEDesign
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SAFEDesign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.__mix_sequences" class="md-nav__link">
    <span class="md-ellipsis">
      __mix_sequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.de_novo_generation" class="md-nav__link">
    <span class="md-ellipsis">
      de_novo_generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.linker_generation" class="md-nav__link">
    <span class="md-ellipsis">
      linker_generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.load_default" class="md-nav__link">
    <span class="md-ellipsis">
      load_default
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.load_from_wandb" class="md-nav__link">
    <span class="md-ellipsis">
      load_from_wandb
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.motif_extension" class="md-nav__link">
    <span class="md-ellipsis">
      motif_extension
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.pattern_decoration" class="md-nav__link">
    <span class="md-ellipsis">
      pattern_decoration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.scaffold_decoration" class="md-nav__link">
    <span class="md-ellipsis">
      scaffold_decoration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.scaffold_morphing" class="md-nav__link">
    <span class="md-ellipsis">
      scaffold_morphing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.sample.SAFEDesign.super_structure" class="md-nav__link">
    <span class="md-ellipsis">
      super_structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe-tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      SAFE Tokenizer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      tokenizer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter" class="md-nav__link">
    <span class="md-ellipsis">
      SAFESplitter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SAFESplitter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter.detokenize" class="md-nav__link">
    <span class="md-ellipsis">
      detokenize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter.pre_tokenize" class="md-nav__link">
    <span class="md-ellipsis">
      pre_tokenize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFESplitter.tokenize" class="md-nav__link">
    <span class="md-ellipsis">
      tokenize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      SAFETokenizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SAFETokenizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.bos_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      bos_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.cls_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      cls_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.eos_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      eos_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.mask_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      mask_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.pad_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      pad_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.sep_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      sep_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.unk_token_id" class="md-nav__link">
    <span class="md-ellipsis">
      unk_token_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.__getstate__" class="md-nav__link">
    <span class="md-ellipsis">
      __getstate__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.__setstate__" class="md-nav__link">
    <span class="md-ellipsis">
      __setstate__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.decode" class="md-nav__link">
    <span class="md-ellipsis">
      decode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.encode" class="md-nav__link">
    <span class="md-ellipsis">
      encode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.from_pretrained" class="md-nav__link">
    <span class="md-ellipsis">
      from_pretrained
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.get_pretrained" class="md-nav__link">
    <span class="md-ellipsis">
      get_pretrained
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.push_to_hub" class="md-nav__link">
    <span class="md-ellipsis">
      push_to_hub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.save_pretrained" class="md-nav__link">
    <span class="md-ellipsis">
      save_pretrained
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.set_special_tokens" class="md-nav__link">
    <span class="md-ellipsis">
      set_special_tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.tokenizer.SAFETokenizer.train_from_iterator" class="md-nav__link">
    <span class="md-ellipsis">
      train_from_iterator
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    <span class="md-ellipsis">
      Utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer" class="md-nav__link">
    <span class="md-ellipsis">
      MolSlicer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MolSlicer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer.get_ring_system" class="md-nav__link">
    <span class="md-ellipsis">
      get_ring_system
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe.utils.MolSlicer.link_fragments" class="md-nav__link">
    <span class="md-ellipsis">
      link_fragments
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.attr_as" class="md-nav__link">
    <span class="md-ellipsis">
      attr_as
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.compute_side_chains" class="md-nav__link">
    <span class="md-ellipsis">
      compute_side_chains
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.convert_to_safe" class="md-nav__link">
    <span class="md-ellipsis">
      convert_to_safe
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.filter_by_substructure_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      filter_by_substructure_constraints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.find_partition_edges" class="md-nav__link">
    <span class="md-ellipsis">
      find_partition_edges
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.fragment_aware_spliting" class="md-nav__link">
    <span class="md-ellipsis">
      fragment_aware_spliting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.list_individual_attach_points" class="md-nav__link">
    <span class="md-ellipsis">
      list_individual_attach_points
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.mol_partition" class="md-nav__link">
    <span class="md-ellipsis">
      mol_partition
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe.utils.standardize_attach" class="md-nav__link">
    <span class="md-ellipsis">
      standardize_attach
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>SAFE</h1>

<h2 id="safe-encoder-decoder">SAFE Encoder-Decoder<a class="headerlink" href="#safe-encoder-decoder" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="safe.converter"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="safe.converter.SAFEConverter" class="doc doc-heading">
            <code>SAFEConverter</code>


<a href="#safe.converter.SAFEConverter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Molecule line notation conversion from SMILES to SAFE</p>
<p>A SAFE representation is a string based representation of a molecule decomposition into fragment components,
separated by a dot ('.'). Note that each component (fragment) might not be a valid molecule by themselves,
unless explicitely correct to add missing hydrogens.</p>
<div class="admonition note">
<p class="admonition-title">Slicing algorithms</p>
<p>By default SAFE strings are generated using <code>BRICS</code>, however, the following alternative are supported:</p>
<ul>
<li><a href="https://pubs.acs.org/doi/10.1021/ci900450m">Hussain-Rea (<code>hr</code>)</a></li>
<li><a href="https://pubmed.ncbi.nlm.nih.gov/9611787/">RECAP (<code>recap</code>)</a></li>
<li><a href="https://www.rdkit.org/docs/source/rdkit.Chem.rdMMPA.html">RDKit's MMPA (<code>mmpa</code>)</a></li>
<li>Any possible attachment points (<code>attach</code>)</li>
</ul>
<p>Furthermore, you can also provide your own slicing algorithm, which should return a pair of atoms
corresponding to the bonds to break.</p>
</div>






              <details class="quote">
                <summary>Source code in <code>safe/converter.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SAFEConverter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Molecule line notation conversion from SMILES to SAFE</span>

<span class="sd">    A SAFE representation is a string based representation of a molecule decomposition into fragment components,</span>
<span class="sd">    separated by a dot (&#39;.&#39;). Note that each component (fragment) might not be a valid molecule by themselves,</span>
<span class="sd">    unless explicitely correct to add missing hydrogens.</span>

<span class="sd">    !!! note &quot;Slicing algorithms&quot;</span>

<span class="sd">        By default SAFE strings are generated using `BRICS`, however, the following alternative are supported:</span>

<span class="sd">        * [Hussain-Rea (`hr`)](https://pubs.acs.org/doi/10.1021/ci900450m)</span>
<span class="sd">        * [RECAP (`recap`)](https://pubmed.ncbi.nlm.nih.gov/9611787/)</span>
<span class="sd">        * [RDKit&#39;s MMPA (`mmpa`)](https://www.rdkit.org/docs/source/rdkit.Chem.rdMMPA.html)</span>
<span class="sd">        * Any possible attachment points (`attach`)</span>

<span class="sd">        Furthermore, you can also provide your own slicing algorithm, which should return a pair of atoms</span>
<span class="sd">        corresponding to the bonds to break.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUPPORTED_SLICERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hr&quot;</span><span class="p">,</span> <span class="s2">&quot;rotatable&quot;</span><span class="p">,</span> <span class="s2">&quot;recap&quot;</span><span class="p">,</span> <span class="s2">&quot;mmpa&quot;</span><span class="p">,</span> <span class="s2">&quot;attach&quot;</span><span class="p">,</span> <span class="s2">&quot;brics&quot;</span><span class="p">]</span>
    <span class="n">__SLICE_SMARTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;hr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;[*]!@-[*]&quot;</span><span class="p">],</span>  <span class="c1"># any non ring single bond</span>
        <span class="s2">&quot;recap&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;[$([C;!$(C([#7])[#7])](=!@[O]))]!@[$([#7;+0;!D1])]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[$(C=!@O)]!@[$([O;+0])]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[$([N;!D1;+0;!$(N-C=[#7,#8,#15,#16])](-!@[*]))]-!@[$([*])]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[$(C(=!@O)([#7;+0;D2,D3])!@[#7;+0;D2,D3])]!@[$([#7;+0;D2,D3])]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[$([O;+0](-!@[#6!$(C=O)])-!@[#6!$(C=O)])]-!@[$([#6!$(C=O)])]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C=!@C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[N;+1;D4]!@[#6]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[$([n;+0])]-!@C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[$([O]=[C]-@[N;+0])]-!@[$([C])]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;c-!@c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[$([#7;+0;D2,D3])]-!@[$([S](=[O])=[O])]&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;mmpa&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;[#6+0;!$(*=,#[!#6])]!@!=!#[*]&quot;</span><span class="p">],</span>  <span class="c1"># classical mmpa slicing smarts</span>
        <span class="s2">&quot;attach&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;[*]!@[*]&quot;</span><span class="p">],</span>  <span class="c1"># any potential attachment point, including hydrogens when explicit</span>
        <span class="s2">&quot;rotatable&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;[!$(*#*)&amp;!D1]-&amp;!@[!$(*#*)&amp;!D1]&quot;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slicer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;brics&quot;</span><span class="p">,</span>
        <span class="n">require_hs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_original_opener_for_attach</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_stereo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for the SAFE converter</span>

<span class="sd">        Args:</span>
<span class="sd">            slicer: slicer algorithm to use for encoding.</span>
<span class="sd">                Can either be one of the supported slicing algorithm (SUPPORTED_SLICERS)</span>
<span class="sd">                or a custom callable that returns the bond ids that can be sliced.</span>
<span class="sd">            require_hs: whether the slicing algorithm require the molecule to have hydrogen explictly added.</span>
<span class="sd">                `attach` slicer requires adding hydrogens.</span>
<span class="sd">            use_original_opener_for_attach: whether to use the original branch opener digit when adding back</span>
<span class="sd">                mapping number to attachment points, or use simple enumeration.</span>
<span class="sd">            ignore_stereo: RDKIT does not support some particular SAFE subset when stereochemistry is defined.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="n">slicer</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slicer</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">slicer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_SLICERS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SLICE_SMARTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">slicer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">!=</span> <span class="s2">&quot;brics&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slicer: </span><span class="si">{</span><span class="n">slicer</span><span class="si">}</span><span class="s2"> cannot be valid&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_hs</span> <span class="o">=</span> <span class="n">require_hs</span> <span class="ow">or</span> <span class="p">(</span><span class="n">slicer</span> <span class="o">==</span> <span class="s2">&quot;attach&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_original_opener_for_attach</span> <span class="o">=</span> <span class="n">use_original_opener_for_attach</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_stereo</span> <span class="o">=</span> <span class="n">ignore_stereo</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">randomize</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Randomize the position of the atoms in a mol.</span>

<span class="sd">        Args:</span>
<span class="sd">            mol: molecules to randomize</span>
<span class="sd">            rng: optional seed to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mol</span>
        <span class="n">atom_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()))</span>
        <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RenumberAtoms</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_find_branch_number</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the branch number and ring closure in the SMILES representation using regexp</span>

<span class="sd">        Args:</span>
<span class="sd">            inp: input smiles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.*?\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="n">matching_groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((?&lt;=%)\d</span><span class="si">{2}</span><span class="s2">)|((?&lt;!%)\d+)(?![^\[]*\])&quot;</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span>
        <span class="c1"># first match is for multiple connection as multiple digits</span>
        <span class="c1"># second match is for single connections requiring 2 digits</span>
        <span class="c1"># SMILES does not support triple digits</span>
        <span class="n">branch_numbers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matching_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">branch_numbers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">branch_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">branch_numbers</span>

    <span class="k">def</span> <span class="nf">_ensure_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure that the input SAFE string is valid by fixing the missing attachment points</span>

<span class="sd">        Args:</span>
<span class="sd">            inp: input SAFE string</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp</span><span class="p">]</span>
        <span class="n">branch_numbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_branch_number</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="c1"># only use the set that have exactly 1 element</span>
        <span class="c1"># any branch number that is not pairwise should receive a dummy atom to complete the attachment point</span>
        <span class="n">branch_numbers</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">branch_numbers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">bnum</span><span class="p">,</span> <span class="n">bcount</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">branch_numbers</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">bcount</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bnum_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bnum</span><span class="p">)</span> <span class="k">if</span> <span class="n">bnum</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">bnum</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_tk</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[*:</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">bnum_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_original_opener_for_attach</span><span class="p">:</span>
                    <span class="n">bnum_digit</span> <span class="o">=</span> <span class="n">bnum_str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>  <span class="c1"># strip out the % sign</span>
                    <span class="n">_tk</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[*:</span><span class="si">{</span><span class="n">bnum_digit</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">bnum_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">missing_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tk</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_tokens</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decoder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">as_mol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">canonical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">remove_dummies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">remove_added_hs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert input SAFE representation to smiles</span>

<span class="sd">        Args:</span>
<span class="sd">            inp: input SAFE representation to decode as a valid molecule or smiles</span>
<span class="sd">            as_mol: whether to return a molecule object or a smiles string</span>
<span class="sd">            canonical: whether to return a canonical</span>
<span class="sd">            fix: whether to fix the SAFE representation to take into account non-connected attachment points</span>
<span class="sd">            remove_dummies: whether to remove dummy atoms from the SAFE representation. Note that removing_dummies is incompatible with</span>
<span class="sd">            remove_added_hs: whether to remove all the added hydrogen atoms after applying dummy removal for recovery</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_valid</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_dummies</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">du</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="s2">&quot;[$([#0]!-!:*);$([#0;D1])]&quot;</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">ReplaceSubstructs</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">remove_dummies</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">as_mol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove_added_hs</span><span class="p">:</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">remove_hs</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">update_explicit_count</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">canonical</span><span class="p">:</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">standardize_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">canonical_tautomer</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mol</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="n">canonical</span><span class="p">,</span> <span class="n">explicit_hs</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">remove_added_hs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">canonical</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">standardize_smiles</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform bond cutting in place for the input molecule, given the slicing algorithm</span>

<span class="sd">        Args:</span>
<span class="sd">            mol: input molecule to split</span>
<span class="sd">            allow_empty: whether to allow the slicing algorithm to return empty bonds</span>
<span class="sd">        Raises:</span>
<span class="sd">            SAFEFragmentationError: if the slicing algorithm return empty bonds</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">matching_bonds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">):</span>
            <span class="n">matching_bonds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">matching_bonds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matching_bonds</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">==</span> <span class="s2">&quot;brics&quot;</span><span class="p">:</span>
            <span class="n">matching_bonds</span> <span class="o">=</span> <span class="n">BRICS</span><span class="o">.</span><span class="n">FindBRICSBonds</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">matching_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">brics_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">brics_match</span> <span class="ow">in</span> <span class="n">matching_bonds</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">smarts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">|=</span> <span class="p">{</span>
                    <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">match</span><span class="p">))</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">smarts</span><span class="p">,</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="n">matching_bonds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">matching_bonds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAFEFragmentationError</span><span class="p">(</span>
                <span class="s2">&quot;Slicing algorithms did not return any bonds that can be cut !&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">matching_bonds</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">encoder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
        <span class="n">canonical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">randomize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">rdkit_safe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert input smiles to SAFE representation</span>

<span class="sd">        Args:</span>
<span class="sd">            inp: input smiles</span>
<span class="sd">            canonical: whether to return canonical smiles string. Defaults to True</span>
<span class="sd">            randomize: whether to randomize the safe string encoding. Will be ignored if canonical is provided</span>
<span class="sd">            seed: optional seed to use when allowing randomization of the SAFE encoding.</span>
<span class="sd">                Randomization happens at two steps:</span>
<span class="sd">                1. at the original smiles representation by randomization the atoms.</span>
<span class="sd">                2. at the SAFE conversion by randomizing fragment orders</span>
<span class="sd">            constraints: List of molecules or pattern to preserve during the SAFE construction. Any bond slicing would</span>
<span class="sd">                happen outside of a substructure matching one of the patterns.</span>
<span class="sd">            allow_empty: whether to allow the slicing algorithm to return empty bonds</span>
<span class="sd">            rdkit_safe: whether to apply rdkit-safe digit standardization to the output SAFE string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">canonical</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="n">canonical</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># EN: we first normalize the attachment if the molecule is a query:</span>
        <span class="c1"># inp = dm.reactions.convert_attach_to_isotope(inp, as_smiles=True)</span>

        <span class="c1"># TODO(maclandrol): RDKit supports some extended form of ring closure, up to 5 digits</span>
        <span class="c1"># https://www.rdkit.org/docs/RDKit_Book.html#ring-closures and I should try to include them</span>
        <span class="n">branch_numbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_branch_number</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">potential_stereos</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">FindPotentialStereo</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">has_stereo_bonds</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Chem</span><span class="o">.</span><span class="n">StereoType</span><span class="o">.</span><span class="n">Bond_Double</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">potential_stereos</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_stereo</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">remove_stereochemistry</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="n">bond_map_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">SetAtomMapNum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">SetIsotope</span><span class="p">(</span><span class="n">bond_map_id</span><span class="p">)</span>
                <span class="n">bond_map_id</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_hs</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">add_hs</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">matching_bonds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="n">allow_empty</span><span class="p">)</span>
        <span class="n">substructed_ignored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">substructed_ignored</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">[</span>
                        <span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_a</span><span class="p">,</span> <span class="n">i_b</span> <span class="ow">in</span> <span class="n">matching_bonds</span><span class="p">:</span>
            <span class="c1"># if both atoms of the bond are found in a disallowed substructure, we cannot consider them</span>
            <span class="c1"># on the other end, a bond between two substructure to preserved independently is perfectly fine</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">i_a</span> <span class="ow">in</span> <span class="n">ignore_x</span> <span class="ow">and</span> <span class="n">i_b</span> <span class="ow">in</span> <span class="n">ignore_x</span><span class="p">)</span> <span class="k">for</span> <span class="n">ignore_x</span> <span class="ow">in</span> <span class="n">substructed_ignored</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">obond</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="n">i_a</span><span class="p">,</span> <span class="n">i_b</span><span class="p">)</span>
            <span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obond</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">FragmentOnBonds</span><span class="p">(</span>
                <span class="n">mol</span><span class="p">,</span>
                <span class="n">bonds</span><span class="p">,</span>
                <span class="n">dummyLabels</span><span class="o">=</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">bond_map_id</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">bond_map_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">))],</span>
            <span class="p">)</span>
        <span class="c1"># here we need to be clever and disable rooted atom as the atom with mapping</span>

        <span class="n">frags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">GetMolFrags</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">asMols</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
            <span class="n">frags</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">frags</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">canonical</span><span class="p">:</span>
            <span class="n">frags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">frags</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">(),</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">frags_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">frags</span><span class="p">:</span>
            <span class="n">non_map_atom_idxs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">frag</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="p">]</span>
            <span class="n">frags_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span>
                    <span class="n">frag</span><span class="p">,</span>
                    <span class="n">isomericSmiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># needs to always be true</span>
                    <span class="n">rootedAtAtom</span><span class="o">=</span><span class="n">non_map_atom_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">scaffold_str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frags_str</span><span class="p">)</span>
        <span class="c1"># EN: fix for https://github.com/datamol-io/safe/issues/37</span>
        <span class="c1"># we were using the wrong branch number count which did not take into account</span>
        <span class="c1"># possible change in digit utilization after bond slicing</span>
        <span class="n">scf_branch_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_branch_number</span><span class="p">(</span><span class="n">scaffold_str</span><span class="p">)</span> <span class="o">+</span> <span class="n">branch_numbers</span>

        <span class="c1"># don&#39;t capture atom mapping in the scaffold</span>
        <span class="n">attach_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\[\d+\*\]|!\[[^:]*:\d+\])&quot;</span><span class="p">,</span> <span class="n">scaffold_str</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">canonical</span><span class="p">:</span>
            <span class="n">attach_pos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attach_pos</span><span class="p">)</span>
        <span class="n">starting_num</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scf_branch_num</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">scf_branch_num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">attach</span> <span class="ow">in</span> <span class="n">attach_pos</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">starting_num</span><span class="p">)</span> <span class="k">if</span> <span class="n">starting_num</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">starting_num</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># we cannot have anything of the form &quot;\([@=-#-$/\]*\d+\)&quot;</span>
            <span class="n">attach_regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">attach</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">scaffold_str</span> <span class="o">=</span> <span class="n">attach_regexp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">scaffold_str</span><span class="p">)</span>
            <span class="n">starting_num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># now we need to remove all the parenthesis around digit only number</span>
        <span class="n">wrong_attach</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([\%\d]*)\)&quot;</span><span class="p">)</span>
        <span class="n">scaffold_str</span> <span class="o">=</span> <span class="n">wrong_attach</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\g&lt;1&gt;&quot;</span><span class="p">,</span> <span class="n">scaffold_str</span><span class="p">)</span>
        <span class="c1"># furthermore, we autoapply rdkit-compatible digit standardization.</span>
        <span class="k">if</span> <span class="n">rdkit_safe</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\(([=-@#\/</span><span class="se">\\</span><span class="s2">]{0,2})(%?\d{1,2})\)&quot;</span>
            <span class="n">replacement</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\g&lt;1&gt;\g&lt;2&gt;&quot;</span>
            <span class="n">scaffold_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">scaffold_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_stereo</span> <span class="ow">and</span> <span class="n">has_stereo_bonds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dm</span><span class="o">.</span><span class="n">same_mol</span><span class="p">(</span><span class="n">scaffold_str</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Ignoring stereo is disabled, but molecule has stereochemistry interferring with SAFE representation&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">scaffold_str</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="safe.converter.SAFEConverter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">slicer</span><span class="o">=</span><span class="s1">&#39;brics&#39;</span><span class="p">,</span> <span class="n">require_hs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_original_opener_for_attach</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_stereo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#safe.converter.SAFEConverter.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Constructor for the SAFE converter</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>slicer</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>], <a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>slicer algorithm to use for encoding.
Can either be one of the supported slicing algorithm (SUPPORTED_SLICERS)
or a custom callable that returns the bond ids that can be sliced.</p>
              </div>
            </td>
            <td>
                  <code>&#39;brics&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_hs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether the slicing algorithm require the molecule to have hydrogen explictly added.
<code>attach</code> slicer requires adding hydrogens.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_original_opener_for_attach</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to use the original branch opener digit when adding back
mapping number to attachment points, or use simple enumeration.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_stereo</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RDKIT does not support some particular SAFE subset when stereochemistry is defined.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">slicer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;brics&quot;</span><span class="p">,</span>
    <span class="n">require_hs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_original_opener_for_attach</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ignore_stereo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructor for the SAFE converter</span>

<span class="sd">    Args:</span>
<span class="sd">        slicer: slicer algorithm to use for encoding.</span>
<span class="sd">            Can either be one of the supported slicing algorithm (SUPPORTED_SLICERS)</span>
<span class="sd">            or a custom callable that returns the bond ids that can be sliced.</span>
<span class="sd">        require_hs: whether the slicing algorithm require the molecule to have hydrogen explictly added.</span>
<span class="sd">            `attach` slicer requires adding hydrogens.</span>
<span class="sd">        use_original_opener_for_attach: whether to use the original branch opener digit when adding back</span>
<span class="sd">            mapping number to attachment points, or use simple enumeration.</span>
<span class="sd">        ignore_stereo: RDKIT does not support some particular SAFE subset when stereochemistry is defined.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="n">slicer</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slicer</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">slicer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_SLICERS</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SLICE_SMARTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">slicer</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">!=</span> <span class="s2">&quot;brics&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slicer: </span><span class="si">{</span><span class="n">slicer</span><span class="si">}</span><span class="s2"> cannot be valid&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">require_hs</span> <span class="o">=</span> <span class="n">require_hs</span> <span class="ow">or</span> <span class="p">(</span><span class="n">slicer</span> <span class="o">==</span> <span class="s2">&quot;attach&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_original_opener_for_attach</span> <span class="o">=</span> <span class="n">use_original_opener_for_attach</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ignore_stereo</span> <span class="o">=</span> <span class="n">ignore_stereo</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.converter.SAFEConverter.decoder" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">decoder</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">as_mol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_dummies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_added_hs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#safe.converter.SAFEConverter.decoder" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Convert input SAFE representation to smiles</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inp</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input SAFE representation to decode as a valid molecule or smiles</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>as_mol</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to return a molecule object or a smiles string</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>canonical</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to return a canonical</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fix</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to fix the SAFE representation to take into account non-connected attachment points</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>remove_dummies</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to remove dummy atoms from the SAFE representation. Note that removing_dummies is incompatible with</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>remove_added_hs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to remove all the added hydrogen atoms after applying dummy removal for recovery</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decoder</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">as_mol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">canonical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">remove_dummies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">remove_added_hs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert input SAFE representation to smiles</span>

<span class="sd">    Args:</span>
<span class="sd">        inp: input SAFE representation to decode as a valid molecule or smiles</span>
<span class="sd">        as_mol: whether to return a molecule object or a smiles string</span>
<span class="sd">        canonical: whether to return a canonical</span>
<span class="sd">        fix: whether to fix the SAFE representation to take into account non-connected attachment points</span>
<span class="sd">        remove_dummies: whether to remove dummy atoms from the SAFE representation. Note that removing_dummies is incompatible with</span>
<span class="sd">        remove_added_hs: whether to remove all the added hydrogen atoms after applying dummy removal for recovery</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_valid</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remove_dummies</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">du</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="s2">&quot;[$([#0]!-!:*);$([#0;D1])]&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">ReplaceSubstructs</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">remove_dummies</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">as_mol</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">remove_added_hs</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">remove_hs</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">update_explicit_count</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">canonical</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">standardize_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">canonical_tautomer</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mol</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="n">canonical</span><span class="p">,</span> <span class="n">explicit_hs</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">remove_added_hs</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">canonical</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">standardize_smiles</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.converter.SAFEConverter.encoder" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">encoder</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rdkit_safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#safe.converter.SAFEConverter.encoder" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Convert input smiles to SAFE representation</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inp</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input smiles</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>canonical</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to return canonical smiles string. Defaults to True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>randomize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to randomize the safe string encoding. Will be ignored if canonical is provided</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional seed to use when allowing randomization of the SAFE encoding.
Randomization happens at two steps:
1. at the original smiles representation by randomization the atoms.
2. at the SAFE conversion by randomizing fragment orders</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>constraints</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<span title="datamol.Mol">Mol</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of molecules or pattern to preserve during the SAFE construction. Any bond slicing would
happen outside of a substructure matching one of the patterns.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_empty</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to allow the slicing algorithm to return empty bonds</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rdkit_safe</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to apply rdkit-safe digit standardization to the output SAFE string.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">encoder</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">inp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
    <span class="n">canonical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">randomize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">rdkit_safe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert input smiles to SAFE representation</span>

<span class="sd">    Args:</span>
<span class="sd">        inp: input smiles</span>
<span class="sd">        canonical: whether to return canonical smiles string. Defaults to True</span>
<span class="sd">        randomize: whether to randomize the safe string encoding. Will be ignored if canonical is provided</span>
<span class="sd">        seed: optional seed to use when allowing randomization of the SAFE encoding.</span>
<span class="sd">            Randomization happens at two steps:</span>
<span class="sd">            1. at the original smiles representation by randomization the atoms.</span>
<span class="sd">            2. at the SAFE conversion by randomizing fragment orders</span>
<span class="sd">        constraints: List of molecules or pattern to preserve during the SAFE construction. Any bond slicing would</span>
<span class="sd">            happen outside of a substructure matching one of the patterns.</span>
<span class="sd">        allow_empty: whether to allow the slicing algorithm to return empty bonds</span>
<span class="sd">        rdkit_safe: whether to apply rdkit-safe digit standardization to the output SAFE string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">canonical</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="n">canonical</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># EN: we first normalize the attachment if the molecule is a query:</span>
    <span class="c1"># inp = dm.reactions.convert_attach_to_isotope(inp, as_smiles=True)</span>

    <span class="c1"># TODO(maclandrol): RDKit supports some extended form of ring closure, up to 5 digits</span>
    <span class="c1"># https://www.rdkit.org/docs/RDKit_Book.html#ring-closures and I should try to include them</span>
    <span class="n">branch_numbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_branch_number</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">potential_stereos</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">FindPotentialStereo</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">has_stereo_bonds</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">Chem</span><span class="o">.</span><span class="n">StereoType</span><span class="o">.</span><span class="n">Bond_Double</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">potential_stereos</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_stereo</span><span class="p">:</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">remove_stereochemistry</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

    <span class="n">bond_map_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">SetAtomMapNum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">SetIsotope</span><span class="p">(</span><span class="n">bond_map_id</span><span class="p">)</span>
            <span class="n">bond_map_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_hs</span><span class="p">:</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">add_hs</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">matching_bonds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="n">allow_empty</span><span class="p">)</span>
    <span class="n">substructed_ignored</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">substructed_ignored</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_a</span><span class="p">,</span> <span class="n">i_b</span> <span class="ow">in</span> <span class="n">matching_bonds</span><span class="p">:</span>
        <span class="c1"># if both atoms of the bond are found in a disallowed substructure, we cannot consider them</span>
        <span class="c1"># on the other end, a bond between two substructure to preserved independently is perfectly fine</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">i_a</span> <span class="ow">in</span> <span class="n">ignore_x</span> <span class="ow">and</span> <span class="n">i_b</span> <span class="ow">in</span> <span class="n">ignore_x</span><span class="p">)</span> <span class="k">for</span> <span class="n">ignore_x</span> <span class="ow">in</span> <span class="n">substructed_ignored</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">obond</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="n">i_a</span><span class="p">,</span> <span class="n">i_b</span><span class="p">)</span>
        <span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obond</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">FragmentOnBonds</span><span class="p">(</span>
            <span class="n">mol</span><span class="p">,</span>
            <span class="n">bonds</span><span class="p">,</span>
            <span class="n">dummyLabels</span><span class="o">=</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">bond_map_id</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">bond_map_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">))],</span>
        <span class="p">)</span>
    <span class="c1"># here we need to be clever and disable rooted atom as the atom with mapping</span>

    <span class="n">frags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">GetMolFrags</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">asMols</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
        <span class="n">frags</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">frags</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">canonical</span><span class="p">:</span>
        <span class="n">frags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">frags</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">(),</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">frags_str</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">frags</span><span class="p">:</span>
        <span class="n">non_map_atom_idxs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">frag</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="p">]</span>
        <span class="n">frags_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span>
                <span class="n">frag</span><span class="p">,</span>
                <span class="n">isomericSmiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># needs to always be true</span>
                <span class="n">rootedAtAtom</span><span class="o">=</span><span class="n">non_map_atom_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">scaffold_str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frags_str</span><span class="p">)</span>
    <span class="c1"># EN: fix for https://github.com/datamol-io/safe/issues/37</span>
    <span class="c1"># we were using the wrong branch number count which did not take into account</span>
    <span class="c1"># possible change in digit utilization after bond slicing</span>
    <span class="n">scf_branch_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_branch_number</span><span class="p">(</span><span class="n">scaffold_str</span><span class="p">)</span> <span class="o">+</span> <span class="n">branch_numbers</span>

    <span class="c1"># don&#39;t capture atom mapping in the scaffold</span>
    <span class="n">attach_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\[\d+\*\]|!\[[^:]*:\d+\])&quot;</span><span class="p">,</span> <span class="n">scaffold_str</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">canonical</span><span class="p">:</span>
        <span class="n">attach_pos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attach_pos</span><span class="p">)</span>
    <span class="n">starting_num</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scf_branch_num</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">scf_branch_num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">attach</span> <span class="ow">in</span> <span class="n">attach_pos</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">starting_num</span><span class="p">)</span> <span class="k">if</span> <span class="n">starting_num</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">starting_num</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># we cannot have anything of the form &quot;\([@=-#-$/\]*\d+\)&quot;</span>
        <span class="n">attach_regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">attach</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="n">scaffold_str</span> <span class="o">=</span> <span class="n">attach_regexp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">scaffold_str</span><span class="p">)</span>
        <span class="n">starting_num</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># now we need to remove all the parenthesis around digit only number</span>
    <span class="n">wrong_attach</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([\%\d]*)\)&quot;</span><span class="p">)</span>
    <span class="n">scaffold_str</span> <span class="o">=</span> <span class="n">wrong_attach</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\g&lt;1&gt;&quot;</span><span class="p">,</span> <span class="n">scaffold_str</span><span class="p">)</span>
    <span class="c1"># furthermore, we autoapply rdkit-compatible digit standardization.</span>
    <span class="k">if</span> <span class="n">rdkit_safe</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\(([=-@#\/</span><span class="se">\\</span><span class="s2">]{0,2})(%?\d{1,2})\)&quot;</span>
        <span class="n">replacement</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\g&lt;1&gt;\g&lt;2&gt;&quot;</span>
        <span class="n">scaffold_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">scaffold_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_stereo</span> <span class="ow">and</span> <span class="n">has_stereo_bonds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dm</span><span class="o">.</span><span class="n">same_mol</span><span class="p">(</span><span class="n">scaffold_str</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Ignoring stereo is disabled, but molecule has stereochemistry interferring with SAFE representation&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">scaffold_str</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.converter.SAFEConverter.randomize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">randomize</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#safe.converter.SAFEConverter.randomize" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Randomize the position of the atoms in a mol.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><span title="datamol.Mol">Mol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>molecules to randomize</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional seed to use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">randomize</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Randomize the position of the atoms in a mol.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: molecules to randomize</span>
<span class="sd">        rng: optional seed to use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mol</span>
    <span class="n">atom_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()))</span>
    <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RenumberAtoms</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="safe.converter.encode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">encode</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slicer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_hs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_stereo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#safe.converter.encode" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert input smiles to SAFE representation</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inp</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input smiles</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>canonical</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to return canonical SAFE string. Defaults to True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>randomize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to randomize the safe string encoding. Will be ignored if canonical is provided</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional seed to use when allowing randomization of the SAFE encoding.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slicer</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>], <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>slicer algorithm to use for encoding. Defaults to "brics".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_hs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether the slicing algorithm require the molecule to have hydrogen explictly added.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>constraints</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<span title="datamol.Mol">Mol</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of molecules or pattern to preserve during the SAFE construction.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_stereo</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RDKIT does not support some particular SAFE subset when stereochemistry is defined.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span>
    <span class="n">inp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
    <span class="n">canonical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">randomize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">slicer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">require_hs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_stereo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert input smiles to SAFE representation</span>

<span class="sd">    Args:</span>
<span class="sd">        inp: input smiles</span>
<span class="sd">        canonical: whether to return canonical SAFE string. Defaults to True</span>
<span class="sd">        randomize: whether to randomize the safe string encoding. Will be ignored if canonical is provided</span>
<span class="sd">        seed: optional seed to use when allowing randomization of the SAFE encoding.</span>
<span class="sd">        slicer: slicer algorithm to use for encoding. Defaults to &quot;brics&quot;.</span>
<span class="sd">        require_hs: whether the slicing algorithm require the molecule to have hydrogen explictly added.</span>
<span class="sd">        constraints: List of molecules or pattern to preserve during the SAFE construction.</span>
<span class="sd">        ignore_stereo: RDKIT does not support some particular SAFE subset when stereochemistry is defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">slicer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slicer</span> <span class="o">=</span> <span class="s2">&quot;brics&quot;</span>
    <span class="k">with</span> <span class="n">dm</span><span class="o">.</span><span class="n">without_rdkit_log</span><span class="p">():</span>
        <span class="n">safe_obj</span> <span class="o">=</span> <span class="n">SAFEConverter</span><span class="p">(</span><span class="n">slicer</span><span class="o">=</span><span class="n">slicer</span><span class="p">,</span> <span class="n">require_hs</span><span class="o">=</span><span class="n">require_hs</span><span class="p">,</span> <span class="n">ignore_stereo</span><span class="o">=</span><span class="n">ignore_stereo</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="n">safe_obj</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span>
                <span class="n">inp</span><span class="p">,</span>
                <span class="n">canonical</span><span class="o">=</span><span class="n">canonical</span><span class="p">,</span>
                <span class="n">randomize</span><span class="o">=</span><span class="n">randomize</span><span class="p">,</span>
                <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">SAFEFragmentationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAFEEncodeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to encode </span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">slicer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">encoded</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.converter.decode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">decode</span><span class="p">(</span><span class="n">safe_str</span><span class="p">,</span> <span class="n">as_mol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_added_hs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_dummies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#safe.converter.decode" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert input SAFE representation to smiles
Args:
    safe_str: input SAFE representation to decode as a valid molecule or smiles
    as_mol: whether to return a molecule object or a smiles string
    canonical: whether to return a canonical smiles or a randomized smiles
    fix: whether to fix the SAFE representation to take into account non-connected attachment points
    remove_added_hs: whether to remove the hydrogen atoms that have been added to fix the string.
    remove_dummies: whether to remove dummy atoms from the SAFE representation
    ignore_errors: whether to ignore error and return None on decoding failure or raise an error</p>

            <details class="quote">
              <summary>Source code in <code>safe/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span>
    <span class="n">safe_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">as_mol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">canonical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">remove_added_hs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">remove_dummies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ignore_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert input SAFE representation to smiles</span>
<span class="sd">    Args:</span>
<span class="sd">        safe_str: input SAFE representation to decode as a valid molecule or smiles</span>
<span class="sd">        as_mol: whether to return a molecule object or a smiles string</span>
<span class="sd">        canonical: whether to return a canonical smiles or a randomized smiles</span>
<span class="sd">        fix: whether to fix the SAFE representation to take into account non-connected attachment points</span>
<span class="sd">        remove_added_hs: whether to remove the hydrogen atoms that have been added to fix the string.</span>
<span class="sd">        remove_dummies: whether to remove dummy atoms from the SAFE representation</span>
<span class="sd">        ignore_errors: whether to ignore error and return None on decoding failure or raise an error</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">dm</span><span class="o">.</span><span class="n">without_rdkit_log</span><span class="p">():</span>
        <span class="n">safe_obj</span> <span class="o">=</span> <span class="n">SAFEConverter</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">safe_obj</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
                <span class="n">safe_str</span><span class="p">,</span>
                <span class="n">as_mol</span><span class="o">=</span><span class="n">as_mol</span><span class="p">,</span>
                <span class="n">canonical</span><span class="o">=</span><span class="n">canonical</span><span class="p">,</span>
                <span class="n">fix</span><span class="o">=</span><span class="n">fix</span><span class="p">,</span>
                <span class="n">remove_dummies</span><span class="o">=</span><span class="n">remove_dummies</span><span class="p">,</span>
                <span class="n">remove_added_hs</span><span class="o">=</span><span class="n">remove_added_hs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="n">SAFEDecodeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode </span><span class="si">{</span><span class="n">safe_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">decoded</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="safe-design">SAFE Design<a class="headerlink" href="#safe-design" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="safe.sample"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="safe.sample.SAFEDesign" class="doc doc-heading">
            <code>SAFEDesign</code>


<a href="#safe.sample.SAFEDesign" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Molecular generation using SAFE pretrained model</p>






              <details class="quote">
                <summary>Source code in <code>safe/sample.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  27</span>
<span class="normal">  28</span>
<span class="normal">  29</span>
<span class="normal">  30</span>
<span class="normal">  31</span>
<span class="normal">  32</span>
<span class="normal">  33</span>
<span class="normal">  34</span>
<span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SAFEDesign</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Molecular generation using SAFE pretrained model&quot;&quot;&quot;</span>

    <span class="n">_DEFAULT_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">1024</span>  <span class="c1"># default max length used during training</span>
    <span class="n">_DEFAULT_MODEL_PATH</span> <span class="o">=</span> <span class="s2">&quot;datamol-io/safe-gpt&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SAFEDoubleHeadsModel</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SAFETokenizer</span><span class="p">],</span>
        <span class="n">generation_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">GenerationConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">safe_encoder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sf</span><span class="o">.</span><span class="n">SAFEConverter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;SAFEDesign constructor</span>

<span class="sd">        !!! info</span>
<span class="sd">            Design methods in SAFE are not deterministic when it comes to the token sampling step.</span>
<span class="sd">            If a method accepts a `random_seed`, it&#39;s for the SAFE-related algorithms and not the</span>
<span class="sd">            sampling from the autoregressive model. To ensure you get a deterministic sampling,</span>
<span class="sd">            please set the seed at the `transformers` package level.</span>

<span class="sd">            ```python</span>
<span class="sd">            import safe as sf</span>
<span class="sd">            import transformers</span>
<span class="sd">            my_seed = 100</span>
<span class="sd">            designer = sf.SAFEDesign(...)</span>

<span class="sd">            transformers.set_seed(100) # use this before calling a design function</span>
<span class="sd">            designer.linker_generation(...)</span>
<span class="sd">            ```</span>


<span class="sd">        Args:</span>
<span class="sd">            model: input SAFEDoubleHeadsModel to use for generation</span>
<span class="sd">            tokenizer: input SAFETokenizer to use for generation</span>
<span class="sd">            generation_config: input GenerationConfig to use for generation</span>
<span class="sd">            safe_encoder: custom safe encoder to use</span>
<span class="sd">            verbose: whether to print out logging information during generation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">SAFEDoubleHeadsModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SAFETokenizer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">):</span>
            <span class="n">generation_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">generation_config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generation_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generation_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="o">.</span><span class="n">from_model_config</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generation_config</span> <span class="o">=</span> <span class="n">generation_config</span>
        <span class="k">for</span> <span class="n">special_token_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bos_token_id&quot;</span><span class="p">,</span> <span class="s2">&quot;eos_token_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pad_token_id&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">special_token_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">special_token_id</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">special_token_id</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span> <span class="o">=</span> <span class="n">safe_encoder</span> <span class="ow">or</span> <span class="n">sf</span><span class="o">.</span><span class="n">SAFEConverter</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_from_wandb</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">artifact_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SAFEDesign&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load SAFE model and tokenizer from a Weights and Biases (wandb) artifact. By default, the model will be downloaded into SAFE_MODEL_ROOT.</span>

<span class="sd">        Args:</span>
<span class="sd">            artifact_path: The path to the wandb artifact in the format `entity/project/artifact:version`.</span>
<span class="sd">            device: The device where the model should be loaded (&#39;cpu&#39; or &#39;cuda&#39;). If None, it defaults to the available device.</span>
<span class="sd">            verbose: Whether to print out logging information during generation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SAFEDesign: An instance of SAFEDesign class with the model, tokenizer, and generation config loaded from wandb.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># EN: potentially remove wandb scheme</span>
        <span class="kn">import</span> <span class="nn">wandb</span>

        <span class="n">artifact_path</span> <span class="o">=</span> <span class="n">artifact_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;wandb://&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Parse the artifact path to extract project and artifact name</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">artifact_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">project_name</span><span class="p">,</span> <span class="n">artifact_name</span> <span class="o">=</span> <span class="n">parts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">project_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SAFE_WANDB_PROJECT&quot;</span><span class="p">,</span> <span class="s2">&quot;safe-models&quot;</span><span class="p">)</span>
            <span class="n">artifact_name</span> <span class="o">=</span> <span class="n">artifact_path</span>

        <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">artifact_name</span><span class="p">:</span>
            <span class="n">artifact_name</span> <span class="o">+=</span> <span class="s2">&quot;:latest&quot;</span>

        <span class="n">artifact_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">artifact_name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Check if SAFE_MODEL_ROOT environment variable is defined</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SAFE_MODEL_ROOT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Ensure the cache path exists</span>
            <span class="n">cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
            <span class="n">cache_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">artifact_subfolder</span> <span class="o">=</span> <span class="n">artifact_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">/</span> <span class="n">artifact_subfolder</span>
            <span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

        <span class="n">api</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Api</span><span class="p">()</span>
        <span class="c1"># Download the artifact from wandb to the cache directory</span>
        <span class="n">artifact</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">artifact</span><span class="p">(</span><span class="n">artifact_path</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
        <span class="n">artifact_dir</span> <span class="o">=</span> <span class="n">artifact</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">cache_path</span><span class="p">)</span>

        <span class="c1"># Load the model, tokenizer, and generation config from the artifact directory</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SAFEDoubleHeadsModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">artifact_dir</span><span class="p">)</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SAFETokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">artifact_dir</span><span class="p">)</span>
        <span class="n">gen_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">artifact_dir</span><span class="p">)</span>

        <span class="c1"># Move model to the specified device if provided</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_config</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_default</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">model_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SAFEDesign&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load default SAFEGenerator model</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: whether to print out logging information during generation</span>
<span class="sd">            model_dir: Optional path to model folder to use instead of the default one.</span>
<span class="sd">                If provided the tokenizer should be in the model_dir named as `tokenizer.json`</span>
<span class="sd">            device: optional device where to move the model</span>
<span class="sd">            kwargs: any additional argument to pass to the init function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model_dir</span><span class="p">:</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MODEL_PATH</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SAFEDoubleHeadsModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SAFETokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
        <span class="n">gen_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_config</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">linker_generation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">groups</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_only</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform linker generation using the pretrained SAFE model.</span>
<span class="sd">        Linker generation is really just scaffold morphing underlying.</span>

<span class="sd">        Args:</span>
<span class="sd">            groups: list of fragments to link together, they are joined in the order provided</span>
<span class="sd">            n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">            n_trials: number of randomization to perform</span>
<span class="sd">            do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">            sanitize: whether to sanitize the generated molecules</span>
<span class="sd">            random_seed: random seed to use</span>
<span class="sd">            model_only: whether to use the model only ability and nothing more.</span>
<span class="sd">            kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">side_chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">side_chains</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Linker generation only works when providing two groups as side chains&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment_linking</span><span class="p">(</span>
            <span class="n">side_chains</span><span class="o">=</span><span class="n">side_chains</span><span class="p">,</span>
            <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
            <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
            <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
            <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">is_linking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scaffold_morphing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">side_chains</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">core</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform scaffold morphing decoration using the pretrained SAFE model</span>

<span class="sd">        For scaffold morphing, we try to replace the core by a new one. If the side_chains are provided, we use them.</span>
<span class="sd">        If a combination of molecule and core is provided, then, we use them to extract the side chains and performing the</span>
<span class="sd">        scaffold morphing then.</span>

<span class="sd">        !!! note &quot;Finding the side chains&quot;</span>
<span class="sd">            The algorithm to find the side chains from core assumes that the core we get as input has attachment points.</span>
<span class="sd">            Those attachment points are never considered as part of the query, rather they are used to define the attachment points.</span>
<span class="sd">            See ~sf.utils.compute_side_chains for more information.</span>

<span class="sd">        Args:</span>
<span class="sd">            side_chains: side chains to use to perform scaffold morphing (joining as best as possible the set of fragments)</span>
<span class="sd">            mol: input molecules when side_chains are not provided</span>
<span class="sd">            core: core to morph into another scaffold</span>
<span class="sd">            n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">            n_trials: number of randomization to perform</span>
<span class="sd">            do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">            sanitize: whether to sanitize the generated molecules</span>
<span class="sd">            random_seed: random seed to use</span>
<span class="sd">            kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment_linking</span><span class="p">(</span>
            <span class="n">side_chains</span><span class="o">=</span><span class="n">side_chains</span><span class="p">,</span>
            <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span>
            <span class="n">core</span><span class="o">=</span><span class="n">core</span><span class="p">,</span>
            <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
            <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
            <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
            <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">is_linking</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fragment_linking</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">side_chains</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">core</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_linking</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">model_only</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform scaffold morphing decoration using the pretrained SAFE model</span>

<span class="sd">        For scaffold morphing, we try to replace the core by a new one. If the side_chains are provided, we use them.</span>
<span class="sd">        If a combination of molecule and core is provided, then, we use them to extract the side chains and performing the</span>
<span class="sd">        scaffold morphing then.</span>

<span class="sd">        !!! note &quot;Finding the side chains&quot;</span>
<span class="sd">            The algorithm to find the side chains from core assumes that the core we get as input has attachment points.</span>
<span class="sd">            Those attachment points are never considered as part of the query, rather they are used to define the attachment points.</span>
<span class="sd">            See ~sf.utils.compute_side_chains for more information.</span>

<span class="sd">        Args:</span>
<span class="sd">            side_chains: side chains to use to perform scaffold morphing (joining as best as possible the set of fragments)</span>
<span class="sd">            mol: input molecules when side_chains are not provided</span>
<span class="sd">            core: core to morph into another scaffold</span>
<span class="sd">            n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">            n_trials: number of randomization to perform</span>
<span class="sd">            do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">            sanitize: whether to sanitize the generated molecules</span>
<span class="sd">            random_seed: random seed to use</span>
<span class="sd">            is_linking: whether it&#39;s a linking task or not.</span>
<span class="sd">                For linking tasks, we use a different custom strategy of completing up to the attachment signal</span>
<span class="sd">            model_only: whether to use the model only ability and nothing more. Only relevant when doing linker generation</span>
<span class="sd">            kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">side_chains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">core</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either side_chains OR mol+core should be provided for scaffold morphing&quot;</span>
                <span class="p">)</span>
            <span class="n">side_chains</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">compute_side_chains</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">core</span><span class="p">)</span>
        <span class="n">side_chains</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">side_chains</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">side_chains</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">side_chains</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">side_chains</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">side_chains</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">side_chains</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Side chain </span><span class="si">{</span><span class="n">side_chains</span><span class="si">}</span><span class="s2"> does not contain any dummy atoms, this might not be what you want&quot;</span>
            <span class="p">)</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">new_seed</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">total_sequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_trials</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">dm</span><span class="o">.</span><span class="n">without_rdkit_log</span><span class="p">():</span>
                <span class="n">context_mng</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="p">,</span> <span class="s2">&quot;slicer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">do_not_fragment_further</span>
                    <span class="k">else</span> <span class="n">suppress</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">old_slicer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="p">,</span> <span class="s2">&quot;slicer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">context_mng</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">encoded_fragment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span>
                            <span class="n">side_chains</span><span class="p">,</span>
                            <span class="n">canonical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">allow_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">seed</span><span class="o">=</span><span class="n">new_seed</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">sf</span><span class="o">.</span><span class="n">SAFEEncodeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to encode </span><span class="si">{</span><span class="n">side_chains</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">old_slicer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="n">old_slicer</span>

            <span class="n">fragments</span> <span class="o">=</span> <span class="n">encoded_fragment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">missing_closure</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="o">.</span><span class="n">_find_branch_number</span><span class="p">(</span><span class="n">encoded_fragment</span><span class="p">))</span>
            <span class="n">missing_closure</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">missing_closure</span> <span class="k">if</span> <span class="n">missing_closure</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">closure_pos</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">missing_closure</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">encoded_fragment</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">fragment_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.&quot;</span><span class="p">,</span> <span class="n">encoded_fragment</span><span class="p">)]</span>
            <span class="n">min_pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">fragment_pos</span><span class="p">[</span><span class="n">min_pos</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">closure_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">min_pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragment_pos</span><span class="p">):</span>
                <span class="n">min_pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">min_pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">max_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragment_pos</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">fragment_pos</span><span class="p">[</span><span class="n">max_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">closure_pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">max_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_pos</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">split_index</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">min_pos</span><span class="p">,</span> <span class="n">max_pos</span><span class="p">)</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">suffixes</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fragments</span><span class="p">[:</span><span class="n">split_index</span><span class="p">]),</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fragments</span><span class="p">[</span><span class="n">split_index</span><span class="p">:])</span>

            <span class="n">missing_prefix_closure</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="o">.</span><span class="n">_find_branch_number</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
            <span class="n">missing_suffix_closure</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="o">.</span><span class="n">_find_branch_number</span><span class="p">(</span><span class="n">suffixes</span><span class="p">))</span>

            <span class="n">missing_prefix_closure</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">missing_closure</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing_prefix_closure</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">missing_suffix_closure</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">missing_closure</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing_suffix_closure</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">constraints_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">permutation</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">missing_closure</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">]):</span>
                <span class="n">constraints_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">permutation</span><span class="p">),</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># prefix_constraints_ids = self.tokenizer.encode(missing_prefix_closure, add_special_tokens=False)</span>
            <span class="c1"># suffix_constraints_ids = self.tokenizer.encode(missing_suffix_closure, add_special_tokens=False)</span>

            <span class="c1"># suffix_ids = self.tokenizer.encode([suffixes+self.tokenizer.tokenizer.eos_token], add_special_tokens=False)</span>
            <span class="c1"># prefix_ids = self.tokenizer.encode([prefix], add_special_tokens=False)</span>

            <span class="n">prefix_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">suffix_kwargs</span> <span class="o">=</span> <span class="n">prefix_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">is_linking</span> <span class="ow">and</span> <span class="n">model_only</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_kwargs</span> <span class="ow">in</span> <span class="p">[</span><span class="n">prefix_kwargs</span><span class="p">,</span> <span class="n">suffix_kwargs</span><span class="p">]:</span>
                    <span class="n">_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;how&quot;</span><span class="p">,</span> <span class="s2">&quot;beam&quot;</span><span class="p">)</span>
                    <span class="n">_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;num_beams&quot;</span><span class="p">,</span> <span class="n">n_samples_per_trial</span><span class="p">)</span>
                    <span class="n">_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;do_sample&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="n">prefix_kwargs</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">suffix_kwargs</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># prefix_kwargs[&quot;constraints&quot;] = [PhrasalConstraint(tkl) for tkl in suffix_constraints_ids]</span>
                <span class="c1"># suffix_kwargs[&quot;constraints&quot;] = [PhrasalConstraint(tkl) for tkl in prefix_constraints_ids]</span>

                <span class="c1"># we first generate a part of the fragment with for unique constraint that it should contain</span>
                <span class="c1"># the closure required to join something to the suffix.</span>
                <span class="n">prefix_kwargs</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">DisjunctiveConstraint</span><span class="p">(</span><span class="n">tkl</span><span class="p">)</span> <span class="k">for</span> <span class="n">tkl</span> <span class="ow">in</span> <span class="n">constraints_ids</span>
                <span class="p">]</span>
                <span class="n">suffix_kwargs</span><span class="p">[</span><span class="s2">&quot;constraints&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">DisjunctiveConstraint</span><span class="p">(</span><span class="n">tkl</span><span class="p">)</span> <span class="k">for</span> <span class="n">tkl</span> <span class="ow">in</span> <span class="n">constraints_ids</span>
                <span class="p">]</span>

                <span class="n">prefix_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span>
                    <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="n">safe_prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">prefix_kwargs</span>
                <span class="p">)</span>
                <span class="n">suffix_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span>
                    <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="n">safe_prefix</span><span class="o">=</span><span class="n">suffixes</span><span class="p">,</span> <span class="o">**</span><span class="n">suffix_kwargs</span>
                <span class="p">)</span>

                <span class="n">prefix_sequences</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_find_fragment_cut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">missing_prefix_closure</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prefix_sequences</span>
                <span class="p">]</span>
                <span class="n">suffix_sequences</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_find_fragment_cut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">,</span> <span class="n">missing_suffix_closure</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">suffix_sequences</span>
                <span class="p">]</span>

                <span class="n">linkers</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">prefix_sequences</span> <span class="o">+</span> <span class="n">suffix_sequences</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
                <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">linker</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">suffixes</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">linker</span> <span class="ow">in</span> <span class="n">linkers</span><span class="p">]</span>
                <span class="n">sequences</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_safe</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_invalid</span><span class="o">=</span><span class="n">sanitize</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">mol_linker_slicer</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MolSlicer</span><span class="p">(</span>
                    <span class="n">shortest_linker</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_linking</span><span class="p">),</span> <span class="n">require_ring_system</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_linking</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">prefix_smiles</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">remove_dummies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">as_mol</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">suffix_smiles</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">suffixes</span><span class="p">,</span> <span class="n">remove_dummies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">as_mol</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">prefix_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span>
                    <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="n">safe_prefix</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">prefix_kwargs</span>
                <span class="p">)</span>
                <span class="n">suffix_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span>
                    <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="n">safe_prefix</span><span class="o">=</span><span class="n">suffixes</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">suffix_kwargs</span>
                <span class="p">)</span>

                <span class="n">prefix_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_safe</span><span class="p">(</span>
                    <span class="n">prefix_sequences</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_invalid</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">suffix_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_safe</span><span class="p">(</span>
                    <span class="n">suffix_sequences</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_invalid</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mix_sequences</span><span class="p">(</span>
                    <span class="n">prefix_sequences</span><span class="p">,</span>
                    <span class="n">suffix_sequences</span><span class="p">,</span>
                    <span class="n">prefix_smiles</span><span class="p">,</span>
                    <span class="n">suffix_smiles</span><span class="p">,</span>
                    <span class="n">n_samples_per_trial</span><span class="p">,</span>
                    <span class="n">mol_linker_slicer</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">total_sequences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>

        <span class="c1"># then we should filter out molecules that do not match the requested</span>
        <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
            <span class="n">total_sequences</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_by_substructure_constraints</span><span class="p">(</span>
                <span class="n">total_sequences</span><span class="p">,</span> <span class="n">side_chains</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %)  generated molecules are valid !&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">total_sequences</span>

    <span class="k">def</span> <span class="nf">motif_extension</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">motif</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform motif extension using the pretrained SAFE model.</span>
<span class="sd">        Motif extension is really just scaffold decoration underlying.</span>

<span class="sd">        Args:</span>
<span class="sd">            motif: scaffold (with attachment points) to decorate</span>
<span class="sd">            n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">            n_trials: number of randomization to perform</span>
<span class="sd">            do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">            sanitize: whether to sanitize the generated molecules and check</span>
<span class="sd">            random_seed: random seed to use</span>
<span class="sd">            kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_decoration</span><span class="p">(</span>
            <span class="n">motif</span><span class="p">,</span>
            <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
            <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
            <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
            <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">add_dot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">super_structure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">core</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">attachment_point_depth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform super structure generation using the pretrained SAFE model.</span>

<span class="sd">        To generate super-structure, we basically just create various attachment points to the input core,</span>
<span class="sd">        then perform scaffold decoration.</span>

<span class="sd">        Args:</span>
<span class="sd">            core: input substructure to use. We aim to generate super structures of this molecule</span>
<span class="sd">            n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">            n_trials: number of different attachment points to consider</span>
<span class="sd">            do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">            sanitize: whether to sanitize the generated molecules</span>
<span class="sd">            random_seed: random seed to use</span>
<span class="sd">            attachment_point_depth: depth of opening the attachment points.</span>
<span class="sd">                Increasing this, means you increase the number of substitution point to consider.</span>
<span class="sd">            kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">core</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">core</span><span class="p">)</span>
        <span class="n">cores</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">list_individual_attach_points</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">attachment_point_depth</span><span class="p">)</span>
        <span class="c1"># get the fully open mol, everytime too.</span>
        <span class="n">cores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">open_attach_points</span><span class="p">(</span><span class="n">core</span><span class="p">)))</span>
        <span class="n">cores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cores</span><span class="p">))</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">cores</span><span class="p">)</span>
        <span class="c1"># now also get the single openining of an attachment point</span>
        <span class="n">total_sequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_trials</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">core</span> <span class="o">=</span> <span class="n">cores</span><span class="p">[</span><span class="n">_</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cores</span><span class="p">)]</span>
            <span class="n">old_verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion</span><span class="p">(</span>
                        <span class="n">fragment</span><span class="o">=</span><span class="n">core</span><span class="p">,</span>
                        <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
                        <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
                        <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
                        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">total_sequences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">old_verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">old_verbose</span>

        <span class="k">if</span> <span class="n">sanitize</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %)  generated molecules are valid !&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">total_sequences</span>

    <span class="k">def</span> <span class="nf">scaffold_decoration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scaffold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">add_dot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform scaffold decoration using the pretrained SAFE model</span>

<span class="sd">        For scaffold decoration, we basically starts with a prefix with the attachment point.</span>
<span class="sd">        We first convert the prefix into valid safe string.</span>

<span class="sd">        Args:</span>
<span class="sd">            scaffold: scaffold (with attachment points) to decorate</span>
<span class="sd">            n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">            n_trials: number of randomization to perform</span>
<span class="sd">            do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">            sanitize: whether to sanitize the generated molecules and check if the scaffold is still present</span>
<span class="sd">            random_seed: random seed to use</span>
<span class="sd">            kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">total_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion</span><span class="p">(</span>
            <span class="n">fragment</span><span class="o">=</span><span class="n">scaffold</span><span class="p">,</span>
            <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
            <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
            <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
            <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">add_dot</span><span class="o">=</span><span class="n">add_dot</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># if we require sanitization</span>
        <span class="c1"># then we should filter out molecules that do not match the requested</span>
        <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
            <span class="n">total_sequences</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_by_substructure_constraints</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">,</span> <span class="n">scaffold</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %)  generated molecules are valid !&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">total_sequences</span>

    <span class="k">def</span> <span class="nf">pattern_decoration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scaffold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">add_dot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">n_scaff_random</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">n_scaff_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">scaff_temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform pattern decoration using the pretrained SAFE model. The pattern decoration algorithm works by first examplifying the patterns</span>
<span class="sd">        as a set of scaffold then performing scaffold decoration on each scaffold.</span>

<span class="sd">        !!! warning</span>
<span class="sd">            Designing molecules from a given molecule pattern is more challenging than fragment-constrained design.</span>
<span class="sd">            SAFE does not currently support complex SMARTS pattern schemes (e.g., valence or connectivity constraints, some ring constraints).</span>
<span class="sd">            This function works best when sampling given a list of atoms. However, sampling depends on the model&#39;s conditional probabilities,</span>
<span class="sd">            meaning that if the model assigns zero probability to a token, you are unlikely to see it.</span>

<span class="sd">        Args:</span>
<span class="sd">            scaffold: Scaffold (with attachment points) to decorate.</span>
<span class="sd">            n_samples_per_trial: Number of new molecules to generate for each randomization.</span>
<span class="sd">            n_trials: Number of randomizations to perform.</span>
<span class="sd">            do_not_fragment_further: Whether to prevent further fragmentation of the scaffold.</span>
<span class="sd">            sanitize: Whether to sanitize the generated molecules and ensure the scaffold is present.</span>
<span class="sd">            random_seed: Seed for randomization.</span>
<span class="sd">            n_scaff_random: Number of scaffold randomizations to try (to reposition constraints in the string and increase rollout likelihood).</span>
<span class="sd">                Increasing this will improve sampling, but will require more time.</span>
<span class="sd">            n_scaff_samples: Maximum number of samples to sample for a given scaffold from the pattern.</span>
<span class="sd">                Increasing this will make sure you have more diversity in the scaffold coming from the pattern</span>
<span class="sd">            scaff_temperature: Temperature to use when sampling valid scaffolds from the pattern. Higher temperature means more diverse scaffold</span>
<span class="sd">            kwargs: Additional arguments for the underlying generation function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of decorated molecule sequences.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">smarts_scaffolds</span> <span class="o">=</span> <span class="p">[</span><span class="n">scaffold</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_scaff_random</span> <span class="ow">and</span> <span class="n">n_scaff_random</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smarts_scaffolds</span> <span class="o">=</span> <span class="n">PatternConstraint</span><span class="o">.</span><span class="n">randomize</span><span class="p">(</span><span class="n">scaffold</span><span class="p">,</span> <span class="n">n_scaff_random</span><span class="p">)</span>

        <span class="n">all_scaffolds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sm</span> <span class="ow">in</span> <span class="n">smarts_scaffolds</span><span class="p">:</span>
            <span class="n">cur_dec_pattern</span> <span class="o">=</span> <span class="n">PatternConstraint</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">scaff_temperature</span><span class="p">)</span>
            <span class="n">decorator</span> <span class="o">=</span> <span class="n">PatternSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">cur_dec_pattern</span><span class="p">)</span>
            <span class="n">cur_scaffolds</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">.</span><span class="n">sample_scaffolds</span><span class="p">(</span>
                <span class="n">n_samples</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="n">n_scaff_samples</span><span class="p">),</span>
                <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">all_scaffolds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cur_scaffolds</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
            <span class="n">all_scaffolds</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_scaffolds</span> <span class="k">if</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">total_sequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scaff</span> <span class="ow">in</span> <span class="n">all_scaffolds</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">without_rdkit_log</span><span class="p">():</span>
                <span class="n">cur_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion</span><span class="p">(</span>
                    <span class="n">fragment</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">scaff</span><span class="p">),</span>
                    <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_samples_per_trial</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_scaffolds</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
                    <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
                    <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
                    <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
                    <span class="n">add_dot</span><span class="o">=</span><span class="n">add_dot</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">total_sequences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cur_sequences</span><span class="p">)</span>

        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
            <span class="n">total_sequences</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_by_substructure_constraints</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">,</span> <span class="n">scaffold</span><span class="p">)</span>
            <span class="n">total_sequences</span> <span class="o">=</span> <span class="n">total_sequences</span><span class="p">[:</span><span class="n">n_samples_per_trial</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%) generated molecules are valid!&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">total_sequences</span><span class="p">[:</span><span class="n">n_samples_per_trial</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">de_novo_generation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform de novo generation using the pretrained SAFE model.</span>

<span class="sd">        De novo generation is equivalent to not having any prefix.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_samples_per_trial: number of new molecules to generate</span>
<span class="sd">            sanitize: whether to perform sanitization, aka, perform control to ensure what is asked is what is returned</span>
<span class="sd">            n_trials: number of randomization to perform</span>
<span class="sd">            kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># EN: lazy programming much ?</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;how&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;how&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;random&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;do_sample&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;I don&#39;t think you know what you are doing ... for de novo generation `do_sample=True` or `how=&#39;random&#39;` is expected !&quot;</span>
            <span class="p">)</span>

        <span class="n">total_sequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_trials</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">total_sequences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
        <span class="n">total_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_safe</span><span class="p">(</span>
            <span class="n">total_sequences</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_invalid</span><span class="o">=</span><span class="n">sanitize</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">sanitize</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %) generated molecules are valid !&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">total_sequences</span>

    <span class="k">def</span> <span class="nf">_find_fragment_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix_constraint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">branching_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a cut on the input fragment in such a way that it could be joined with another fragments sharing the same</span>
<span class="sd">        branching id.</span>

<span class="sd">        Args:</span>
<span class="sd">            fragment: fragment to cut</span>
<span class="sd">            prefix_constraint: prefix constraint to use</span>
<span class="sd">            branching_id: branching id to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix_constraint</span> <span class="o">=</span> <span class="n">prefix_constraint</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">fragment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix_constraint</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fragment</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix_constraint</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">fragment</span>
        <span class="p">)</span>
        <span class="n">fragments</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">branching_id</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fragments</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__mix_sequences</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix_sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">suffix_sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mol_linker_slicer</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use generated prefix and suffix sequences to form new molecules</span>
<span class="sd">        that will be the merging of both. This is the two step scaffold morphing and linker generation scheme</span>
<span class="sd">        Args:</span>
<span class="sd">            prefix_sequences: list of prefix sequences</span>
<span class="sd">            suffix_sequences: list of suffix sequences</span>
<span class="sd">            prefix: decoded smiles of the prefix</span>
<span class="sd">            suffix: decoded smiles of the suffix</span>
<span class="sd">            n_samples: number of samples to generate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix_linkers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">suffix_linkers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prefix_query</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">suffix_query</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prefix_sequences</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">mol_linker_slicer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prefix_query</span><span class="p">)</span>
                <span class="n">prefix_linkers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">suffix_sequences</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">mol_linker_slicer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">suffix_query</span><span class="p">)</span>
                <span class="n">suffix_linkers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">n_linked</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">linked</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">linkers</span> <span class="o">=</span> <span class="n">prefix_linkers</span> <span class="o">+</span> <span class="n">suffix_linkers</span>
        <span class="n">linkers</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linkers</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">n_linked</span><span class="p">,</span> <span class="n">linker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">linkers</span><span class="p">):</span>
            <span class="n">linked</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mol_linker_slicer</span><span class="o">.</span><span class="n">link_fragments</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">n_linked</span> <span class="o">&gt;</span> <span class="n">n_samples</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">linked</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linked</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">linked</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_decode_safe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">canonical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">remove_invalid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decode a safe sequence into a molecule</span>

<span class="sd">        Args:</span>
<span class="sd">            sequence: safe sequence to decode</span>
<span class="sd">            canonical: whether to return canonical sequence</span>
<span class="sd">            remove_invalid: whether to remove invalid safe strings or keep them</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_decode_fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">as_mol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">remove_added_hs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">canonical</span><span class="o">=</span><span class="n">canonical</span><span class="p">,</span>
                <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">remove_dummies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">safe_strings</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">parallelized</span><span class="p">(</span><span class="n">_decode_fn</span><span class="p">,</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">safe_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">_decode_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">remove_invalid</span><span class="p">:</span>
            <span class="n">safe_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">safe_strings</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">safe_strings</span>

    <span class="k">def</span> <span class="nf">_completion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fragment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
        <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">add_dot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">is_safe</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform sentence completion using a prefix fragment</span>

<span class="sd">        Args:</span>
<span class="sd">            fragment: fragment (with attachment points)</span>
<span class="sd">            n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">            n_trials: number of randomization to perform</span>
<span class="sd">            do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">            sanitize: whether to sanitize the generated molecules</span>
<span class="sd">            random_seed: random seed to use</span>
<span class="sd">            is_safe: whether the smiles is already encoded as a safe string</span>
<span class="sd">            add_dot: whether to add a dot at the end of the fragments to signal to the model that we want to generate a distinct fragment.</span>
<span class="sd">            kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># EN: lazy programming much ?</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;how&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;how&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;random&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;do_sample&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;I don&#39;t think you know what you are doing ... for de novo generation `do_sample=True` or `how=&#39;random&#39;` is expected !&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Step 1: we conver the fragment into the relevant safe string format</span>
        <span class="c1"># we use the provided safe encoder with the slicer that was expected</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">new_seed</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">total_sequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_trials</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_safe</span><span class="p">:</span>
                <span class="n">encoded_fragment</span> <span class="o">=</span> <span class="n">fragment</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">dm</span><span class="o">.</span><span class="n">without_rdkit_log</span><span class="p">():</span>
                    <span class="n">context_mng</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="p">,</span> <span class="s2">&quot;slicer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">do_not_fragment_further</span>
                        <span class="k">else</span> <span class="n">suppress</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">old_slicer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="p">,</span> <span class="s2">&quot;slicer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">context_mng</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">encoded_fragment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span>
                                <span class="n">fragment</span><span class="p">,</span>
                                <span class="n">canonical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">randomize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">allow_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">new_seed</span><span class="p">,</span>
                            <span class="p">)</span>

                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">sf</span><span class="o">.</span><span class="n">SAFEEncodeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to encode </span><span class="si">{</span><span class="n">fragment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">old_slicer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span><span class="o">.</span><span class="n">slicer</span> <span class="o">=</span> <span class="n">old_slicer</span>

            <span class="k">if</span> <span class="n">add_dot</span> <span class="ow">and</span> <span class="n">encoded_fragment</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">encoded_fragment</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
                <span class="n">encoded_fragment</span> <span class="o">=</span> <span class="n">encoded_fragment</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>

            <span class="n">sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span>
                <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="n">safe_prefix</span><span class="o">=</span><span class="n">encoded_fragment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

            <span class="n">sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_safe</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_invalid</span><span class="o">=</span><span class="n">sanitize</span><span class="p">)</span>
            <span class="n">total_sequences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total_sequences</span>

    <span class="k">def</span> <span class="nf">_generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">safe_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">how</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span>
        <span class="n">num_beams</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_beam_groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_sample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample a new sequence using the underlying hugging face model.</span>
<span class="sd">        This emulates the izanagi sampling models, if you wish to retain the hugging face generation</span>
<span class="sd">        behaviour, either call the hugging face functions directly or overwrite this function</span>

<span class="sd">        ??? note &quot;Generation Parameters&quot;</span>
<span class="sd">            From the hugging face documentation:</span>

<span class="sd">            * `greedy decoding` if how=&quot;greedy&quot; and num_beams=1 and do_sample=False.</span>
<span class="sd">            * `multinomial sampling` if num_beams=1 and do_sample=True.</span>
<span class="sd">            * `beam-search decoding` if how=&quot;beam&quot; and num_beams&gt;1 and do_sample=False.</span>
<span class="sd">            * `beam-search multinomial` sampling by calling if beam=True, num_beams&gt;1 and do_sample=True or how=&quot;random&quot; and num_beams&gt;1</span>
<span class="sd">            * `diverse beam-search decoding` if num_beams&gt;1 and num_beam_groups&gt;1</span>

<span class="sd">            It&#39;s also possible to ignore the &#39;how&#39; shortcut and directly call the underlying generation methods using the proper arguments.</span>
<span class="sd">            Learn more here: https://huggingface.co/docs/transformers/v4.32.0/en/main_classes/text_generation#transformers.GenerationConfig</span>
<span class="sd">            Under the hood, the following will be applied depending on the arguments:</span>

<span class="sd">            * greedy decoding by calling greedy_search() if num_beams=1 and do_sample=False</span>
<span class="sd">            * contrastive search by calling contrastive_search() if penalty_alpha&gt;0. and top_k&gt;1</span>
<span class="sd">            * multinomial sampling by calling sample() if num_beams=1 and do_sample=True</span>
<span class="sd">            * beam-search decoding by calling beam_search() if num_beams&gt;1 and do_sample=False</span>
<span class="sd">            * beam-search multinomial sampling by calling beam_sample() if num_beams&gt;1 and do_sample=True</span>
<span class="sd">            * diverse beam-search decoding by calling group_beam_search(), if num_beams&gt;1 and num_beam_groups&gt;1</span>
<span class="sd">            * constrained beam-search decoding by calling constrained_beam_search(), if constraints!=None or force_words_ids!=None</span>
<span class="sd">            * assisted decoding by calling assisted_decoding(), if assistant_model is passed to .generate()</span>

<span class="sd">        Args:</span>
<span class="sd">            n_samples: number of sequences to return</span>
<span class="sd">            safe_prefix: Prefix to use in sampling, should correspond to a safe fragment</span>
<span class="sd">            max_length : maximum length of sampled sequence</span>
<span class="sd">            how: which sampling method to use: &quot;beam&quot;, &quot;greedy&quot; or &quot;random&quot;. Can be used to control other parameters by setting defaults</span>
<span class="sd">            num_beams: number of beams for beam search. 1 means no beam search, unless beam is specified then max(n_samples, num_beams) is used</span>
<span class="sd">            num_beam_groups: number of beam groups for diverse beam search</span>
<span class="sd">            do_sample: whether to perform random sampling or not, equivalent to setting random to True</span>
<span class="sd">            kwargs: any additional keyword argument to pass to the underlying sampling `generate`  from hugging face transformer</span>

<span class="sd">        Returns:</span>
<span class="sd">            samples: list of sampled molecules, including failed validation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pretrained_tk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">get_pretrained</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pretrained_tk</span><span class="p">,</span> <span class="s2">&quot;model_max_length&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="n">pretrained_tk</span><span class="p">,</span>
                <span class="s2">&quot;model_max_length&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_MAX_LENGTH</span><span class="p">,</span>  <span class="c1"># this was the defaul</span>
            <span class="p">)</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">safe_prefix</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">safe_prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># EN: should we address the special token issues</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">pretrained_tk</span><span class="p">(</span>
                <span class="n">safe_prefix</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">num_beams</span> <span class="o">=</span> <span class="n">num_beams</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">do_sample</span> <span class="o">=</span> <span class="n">do_sample</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="n">do_sample</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">how</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;beam&quot;</span> <span class="ow">in</span> <span class="n">how</span><span class="p">:</span>
            <span class="n">num_beams</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">num_beams</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span> <span class="n">n_samples</span><span class="p">)</span>

        <span class="n">is_greedy</span> <span class="o">=</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;greedy&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_beams</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="ow">and</span> <span class="n">do_sample</span> <span class="ow">is</span> <span class="kc">False</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;do_sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_sample</span>
        <span class="k">if</span> <span class="n">num_beams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;num_beams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_beams</span>
        <span class="k">if</span> <span class="n">num_beam_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;num_beam_groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_beam_groups</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;output_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;return_dict_in_generate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;num_return_sequences&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_samples</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;max_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_length</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;early_stopping&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># EN we don&#39;t do anything with the score that the model might return on generate ...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># EN: we remove the EOS token added before running the prediction</span>
            <span class="c1"># because the model output nonsense when we keep it.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_ids</span><span class="p">:</span>
                <span class="n">input_ids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">input_ids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># we remove the token_type_ids to support more model type than just GPT2</span>
        <span class="n">input_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;token_type_ids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_greedy</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;num_return_sequences&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_beams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_beams</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set num_beams|num_beam_groups &gt; 1 for greedy&quot;</span><span class="p">)</span>
            <span class="c1"># under greedy decoding there can only be a single solution</span>
            <span class="c1"># we just duplicate the solution several time for efficiency</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="o">**</span><span class="n">input_ids</span><span class="p">,</span>
                <span class="n">generation_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generation_config</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">pretrained_tk</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">*</span> <span class="n">n_samples</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="o">**</span><span class="n">input_ids</span><span class="p">,</span>
                <span class="n">generation_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generation_config</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="n">pretrained_tk</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">sequences</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sequences</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">safe_encoder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>SAFEDesign constructor</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Design methods in SAFE are not deterministic when it comes to the token sampling step.
If a method accepts a <code>random_seed</code>, it's for the SAFE-related algorithms and not the
sampling from the autoregressive model. To ensure you get a deterministic sampling,
please set the seed at the <code>transformers</code> package level.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">safe</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">import</span> <span class="nn">transformers</span>
<span class="n">my_seed</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">designer</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">SAFEDesign</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">transformers</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># use this before calling a design function</span>
<span class="n">designer</span><span class="o">.</span><span class="n">linker_generation</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
</div>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-internal" title="safe.trainer.model.SAFEDoubleHeadsModel" href="safe.models.html#safe.trainer.model.SAFEDoubleHeadsModel">SAFEDoubleHeadsModel</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input SAFEDoubleHeadsModel to use for generation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-internal" title="safe.tokenizer.SAFETokenizer" href="#safe.tokenizer.SAFETokenizer">SAFETokenizer</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input SAFETokenizer to use for generation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>generation_config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="transformers.GenerationConfig">GenerationConfig</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input GenerationConfig to use for generation</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>safe_encoder</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="safe.SAFEConverter" href="#safe.converter.SAFEConverter">SAFEConverter</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>custom safe encoder to use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to print out logging information during generation</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SAFEDoubleHeadsModel</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SAFETokenizer</span><span class="p">],</span>
    <span class="n">generation_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">GenerationConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">safe_encoder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sf</span><span class="o">.</span><span class="n">SAFEConverter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SAFEDesign constructor</span>

<span class="sd">    !!! info</span>
<span class="sd">        Design methods in SAFE are not deterministic when it comes to the token sampling step.</span>
<span class="sd">        If a method accepts a `random_seed`, it&#39;s for the SAFE-related algorithms and not the</span>
<span class="sd">        sampling from the autoregressive model. To ensure you get a deterministic sampling,</span>
<span class="sd">        please set the seed at the `transformers` package level.</span>

<span class="sd">        ```python</span>
<span class="sd">        import safe as sf</span>
<span class="sd">        import transformers</span>
<span class="sd">        my_seed = 100</span>
<span class="sd">        designer = sf.SAFEDesign(...)</span>

<span class="sd">        transformers.set_seed(100) # use this before calling a design function</span>
<span class="sd">        designer.linker_generation(...)</span>
<span class="sd">        ```</span>


<span class="sd">    Args:</span>
<span class="sd">        model: input SAFEDoubleHeadsModel to use for generation</span>
<span class="sd">        tokenizer: input SAFETokenizer to use for generation</span>
<span class="sd">        generation_config: input GenerationConfig to use for generation</span>
<span class="sd">        safe_encoder: custom safe encoder to use</span>
<span class="sd">        verbose: whether to print out logging information during generation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SAFEDoubleHeadsModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SAFETokenizer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">):</span>
        <span class="n">generation_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">generation_config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">generation_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">generation_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="o">.</span><span class="n">from_model_config</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">generation_config</span> <span class="o">=</span> <span class="n">generation_config</span>
    <span class="k">for</span> <span class="n">special_token_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bos_token_id&quot;</span><span class="p">,</span> <span class="s2">&quot;eos_token_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pad_token_id&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">special_token_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">special_token_id</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">special_token_id</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">safe_encoder</span> <span class="o">=</span> <span class="n">safe_encoder</span> <span class="ow">or</span> <span class="n">sf</span><span class="o">.</span><span class="n">SAFEConverter</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.__mix_sequences" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__mix_sequences</span><span class="p">(</span><span class="n">prefix_sequences</span><span class="p">,</span> <span class="n">suffix_sequences</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">mol_linker_slicer</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.__mix_sequences" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Use generated prefix and suffix sequences to form new molecules
that will be the merging of both. This is the two step scaffold morphing and linker generation scheme
Args:
    prefix_sequences: list of prefix sequences
    suffix_sequences: list of suffix sequences
    prefix: decoded smiles of the prefix
    suffix: decoded smiles of the suffix
    n_samples: number of samples to generate</p>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">__mix_sequences</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">prefix_sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">suffix_sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">mol_linker_slicer</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use generated prefix and suffix sequences to form new molecules</span>
<span class="sd">    that will be the merging of both. This is the two step scaffold morphing and linker generation scheme</span>
<span class="sd">    Args:</span>
<span class="sd">        prefix_sequences: list of prefix sequences</span>
<span class="sd">        suffix_sequences: list of suffix sequences</span>
<span class="sd">        prefix: decoded smiles of the prefix</span>
<span class="sd">        suffix: decoded smiles of the suffix</span>
<span class="sd">        n_samples: number of samples to generate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix_linkers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">suffix_linkers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prefix_query</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">suffix_query</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prefix_sequences</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">mol_linker_slicer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prefix_query</span><span class="p">)</span>
            <span class="n">prefix_linkers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">suffix_sequences</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">mol_linker_slicer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">suffix_query</span><span class="p">)</span>
            <span class="n">suffix_linkers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">n_linked</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linked</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">linkers</span> <span class="o">=</span> <span class="n">prefix_linkers</span> <span class="o">+</span> <span class="n">suffix_linkers</span>
    <span class="n">linkers</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linkers</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">n_linked</span><span class="p">,</span> <span class="n">linker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">linkers</span><span class="p">):</span>
        <span class="n">linked</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mol_linker_slicer</span><span class="o">.</span><span class="n">link_fragments</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_linked</span> <span class="o">&gt;</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">linked</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linked</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">linked</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.de_novo_generation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">de_novo_generation</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.de_novo_generation" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform de novo generation using the pretrained SAFE model.</p>
<p>De novo generation is equivalent to not having any prefix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n_samples_per_trial</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of new molecules to generate</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sanitize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to perform sanitization, aka, perform control to ensure what is asked is what is returned</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_trials</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of randomization to perform</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any argument to provide to the underlying generation function</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">de_novo_generation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform de novo generation using the pretrained SAFE model.</span>

<span class="sd">    De novo generation is equivalent to not having any prefix.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_samples_per_trial: number of new molecules to generate</span>
<span class="sd">        sanitize: whether to perform sanitization, aka, perform control to ensure what is asked is what is returned</span>
<span class="sd">        n_trials: number of randomization to perform</span>
<span class="sd">        kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># EN: lazy programming much ?</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;how&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;how&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;random&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;do_sample&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;I don&#39;t think you know what you are doing ... for de novo generation `do_sample=True` or `how=&#39;random&#39;` is expected !&quot;</span>
        <span class="p">)</span>

    <span class="n">total_sequences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_trials</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">total_sequences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
    <span class="n">total_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_safe</span><span class="p">(</span>
        <span class="n">total_sequences</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_invalid</span><span class="o">=</span><span class="n">sanitize</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">sanitize</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %) generated molecules are valid !&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">total_sequences</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.linker_generation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">linker_generation</span><span class="p">(</span><span class="o">*</span><span class="n">groups</span><span class="p">,</span> <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.linker_generation" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform linker generation using the pretrained SAFE model.
Linker generation is really just scaffold morphing underlying.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>groups</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of fragments to link together, they are joined in the order provided</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples_per_trial</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of new molecules to generate for each randomization</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_trials</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of randomization to perform</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>do_not_fragment_further</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to fragment the scaffold further or not</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sanitize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to sanitize the generated molecules</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random seed to use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_only</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to use the model only ability and nothing more.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any argument to provide to the underlying generation function</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">linker_generation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="n">groups</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
    <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model_only</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform linker generation using the pretrained SAFE model.</span>
<span class="sd">    Linker generation is really just scaffold morphing underlying.</span>

<span class="sd">    Args:</span>
<span class="sd">        groups: list of fragments to link together, they are joined in the order provided</span>
<span class="sd">        n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">        n_trials: number of randomization to perform</span>
<span class="sd">        do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">        sanitize: whether to sanitize the generated molecules</span>
<span class="sd">        random_seed: random seed to use</span>
<span class="sd">        model_only: whether to use the model only ability and nothing more.</span>
<span class="sd">        kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">side_chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">side_chains</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Linker generation only works when providing two groups as side chains&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment_linking</span><span class="p">(</span>
        <span class="n">side_chains</span><span class="o">=</span><span class="n">side_chains</span><span class="p">,</span>
        <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="n">is_linking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.load_default" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_default</span><span class="p">(</span><span class="n">model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#safe.sample.SAFEDesign.load_default" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Load default SAFEGenerator model</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to print out logging information during generation</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_dir</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path to model folder to use instead of the default one.
If provided the tokenizer should be in the model_dir named as <code>tokenizer.json</code></p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional device where to move the model</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any additional argument to pass to the init function</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">load_default</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">model_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SAFEDesign&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load default SAFEGenerator model</span>

<span class="sd">    Args:</span>
<span class="sd">        verbose: whether to print out logging information during generation</span>
<span class="sd">        model_dir: Optional path to model folder to use instead of the default one.</span>
<span class="sd">            If provided the tokenizer should be in the model_dir named as `tokenizer.json`</span>
<span class="sd">        device: optional device where to move the model</span>
<span class="sd">        kwargs: any additional argument to pass to the init function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model_dir</span><span class="p">:</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MODEL_PATH</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SAFEDoubleHeadsModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SAFETokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="n">gen_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_config</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.load_from_wandb" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_from_wandb</span><span class="p">(</span><span class="n">artifact_path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#safe.sample.SAFEDesign.load_from_wandb" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Load SAFE model and tokenizer from a Weights and Biases (wandb) artifact. By default, the model will be downloaded into SAFE_MODEL_ROOT.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>artifact_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the wandb artifact in the format <code>entity/project/artifact:version</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The device where the model should be loaded ('cpu' or 'cuda'). If None, it defaults to the available device.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print out logging information during generation.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SAFEDesign</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="safe.sample.SAFEDesign" href="#safe.sample.SAFEDesign">SAFEDesign</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of SAFEDesign class with the model, tokenizer, and generation config loaded from wandb.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">load_from_wandb</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">artifact_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SAFEDesign&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load SAFE model and tokenizer from a Weights and Biases (wandb) artifact. By default, the model will be downloaded into SAFE_MODEL_ROOT.</span>

<span class="sd">    Args:</span>
<span class="sd">        artifact_path: The path to the wandb artifact in the format `entity/project/artifact:version`.</span>
<span class="sd">        device: The device where the model should be loaded (&#39;cpu&#39; or &#39;cuda&#39;). If None, it defaults to the available device.</span>
<span class="sd">        verbose: Whether to print out logging information during generation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SAFEDesign: An instance of SAFEDesign class with the model, tokenizer, and generation config loaded from wandb.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># EN: potentially remove wandb scheme</span>
    <span class="kn">import</span> <span class="nn">wandb</span>

    <span class="n">artifact_path</span> <span class="o">=</span> <span class="n">artifact_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;wandb://&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Parse the artifact path to extract project and artifact name</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">artifact_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">project_name</span><span class="p">,</span> <span class="n">artifact_name</span> <span class="o">=</span> <span class="n">parts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SAFE_WANDB_PROJECT&quot;</span><span class="p">,</span> <span class="s2">&quot;safe-models&quot;</span><span class="p">)</span>
        <span class="n">artifact_name</span> <span class="o">=</span> <span class="n">artifact_path</span>

    <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">artifact_name</span><span class="p">:</span>
        <span class="n">artifact_name</span> <span class="o">+=</span> <span class="s2">&quot;:latest&quot;</span>

    <span class="n">artifact_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">artifact_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Check if SAFE_MODEL_ROOT environment variable is defined</span>
    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SAFE_MODEL_ROOT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cache_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Ensure the cache path exists</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
        <span class="n">cache_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">artifact_subfolder</span> <span class="o">=</span> <span class="n">artifact_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">/</span> <span class="n">artifact_subfolder</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

    <span class="n">api</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Api</span><span class="p">()</span>
    <span class="c1"># Download the artifact from wandb to the cache directory</span>
    <span class="n">artifact</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">artifact</span><span class="p">(</span><span class="n">artifact_path</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="n">artifact_dir</span> <span class="o">=</span> <span class="n">artifact</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">cache_path</span><span class="p">)</span>

    <span class="c1"># Load the model, tokenizer, and generation config from the artifact directory</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SAFEDoubleHeadsModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">artifact_dir</span><span class="p">)</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SAFETokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">artifact_dir</span><span class="p">)</span>
    <span class="n">gen_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">artifact_dir</span><span class="p">)</span>

    <span class="c1"># Move model to the specified device if provided</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_config</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.motif_extension" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">motif_extension</span><span class="p">(</span><span class="n">motif</span><span class="p">,</span> <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.motif_extension" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform motif extension using the pretrained SAFE model.
Motif extension is really just scaffold decoration underlying.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>motif</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>scaffold (with attachment points) to decorate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples_per_trial</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of new molecules to generate for each randomization</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_trials</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of randomization to perform</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>do_not_fragment_further</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to fragment the scaffold further or not</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sanitize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to sanitize the generated molecules and check</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random seed to use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any argument to provide to the underlying generation function</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">motif_extension</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">motif</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
    <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform motif extension using the pretrained SAFE model.</span>
<span class="sd">    Motif extension is really just scaffold decoration underlying.</span>

<span class="sd">    Args:</span>
<span class="sd">        motif: scaffold (with attachment points) to decorate</span>
<span class="sd">        n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">        n_trials: number of randomization to perform</span>
<span class="sd">        do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">        sanitize: whether to sanitize the generated molecules and check</span>
<span class="sd">        random_seed: random seed to use</span>
<span class="sd">        kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaffold_decoration</span><span class="p">(</span>
        <span class="n">motif</span><span class="p">,</span>
        <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="n">add_dot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.pattern_decoration" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pattern_decoration</span><span class="p">(</span><span class="n">scaffold</span><span class="p">,</span> <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_dot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_scaff_random</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_scaff_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scaff_temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.pattern_decoration" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform pattern decoration using the pretrained SAFE model. The pattern decoration algorithm works by first examplifying the patterns
as a set of scaffold then performing scaffold decoration on each scaffold.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Designing molecules from a given molecule pattern is more challenging than fragment-constrained design.
SAFE does not currently support complex SMARTS pattern schemes (e.g., valence or connectivity constraints, some ring constraints).
This function works best when sampling given a list of atoms. However, sampling depends on the model's conditional probabilities,
meaning that if the model assigns zero probability to a token, you are unlikely to see it.</p>
</div>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>scaffold</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scaffold (with attachment points) to decorate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples_per_trial</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of new molecules to generate for each randomization.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_trials</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of randomizations to perform.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>do_not_fragment_further</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to prevent further fragmentation of the scaffold.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sanitize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to sanitize the generated molecules and ensure the scaffold is present.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Seed for randomization.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_scaff_random</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of scaffold randomizations to try (to reposition constraints in the string and increase rollout likelihood).
Increasing this will improve sampling, but will require more time.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_scaff_samples</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of samples to sample for a given scaffold from the pattern.
Increasing this will make sure you have more diversity in the scaffold coming from the pattern</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scaff_temperature</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Temperature to use when sampling valid scaffolds from the pattern. Higher temperature means more diverse scaffold</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the underlying generation function.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of decorated molecule sequences.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pattern_decoration</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">scaffold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
    <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_dot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">n_scaff_random</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">n_scaff_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">scaff_temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform pattern decoration using the pretrained SAFE model. The pattern decoration algorithm works by first examplifying the patterns</span>
<span class="sd">    as a set of scaffold then performing scaffold decoration on each scaffold.</span>

<span class="sd">    !!! warning</span>
<span class="sd">        Designing molecules from a given molecule pattern is more challenging than fragment-constrained design.</span>
<span class="sd">        SAFE does not currently support complex SMARTS pattern schemes (e.g., valence or connectivity constraints, some ring constraints).</span>
<span class="sd">        This function works best when sampling given a list of atoms. However, sampling depends on the model&#39;s conditional probabilities,</span>
<span class="sd">        meaning that if the model assigns zero probability to a token, you are unlikely to see it.</span>

<span class="sd">    Args:</span>
<span class="sd">        scaffold: Scaffold (with attachment points) to decorate.</span>
<span class="sd">        n_samples_per_trial: Number of new molecules to generate for each randomization.</span>
<span class="sd">        n_trials: Number of randomizations to perform.</span>
<span class="sd">        do_not_fragment_further: Whether to prevent further fragmentation of the scaffold.</span>
<span class="sd">        sanitize: Whether to sanitize the generated molecules and ensure the scaffold is present.</span>
<span class="sd">        random_seed: Seed for randomization.</span>
<span class="sd">        n_scaff_random: Number of scaffold randomizations to try (to reposition constraints in the string and increase rollout likelihood).</span>
<span class="sd">            Increasing this will improve sampling, but will require more time.</span>
<span class="sd">        n_scaff_samples: Maximum number of samples to sample for a given scaffold from the pattern.</span>
<span class="sd">            Increasing this will make sure you have more diversity in the scaffold coming from the pattern</span>
<span class="sd">        scaff_temperature: Temperature to use when sampling valid scaffolds from the pattern. Higher temperature means more diverse scaffold</span>
<span class="sd">        kwargs: Additional arguments for the underlying generation function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of decorated molecule sequences.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">smarts_scaffolds</span> <span class="o">=</span> <span class="p">[</span><span class="n">scaffold</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">n_scaff_random</span> <span class="ow">and</span> <span class="n">n_scaff_random</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">smarts_scaffolds</span> <span class="o">=</span> <span class="n">PatternConstraint</span><span class="o">.</span><span class="n">randomize</span><span class="p">(</span><span class="n">scaffold</span><span class="p">,</span> <span class="n">n_scaff_random</span><span class="p">)</span>

    <span class="n">all_scaffolds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sm</span> <span class="ow">in</span> <span class="n">smarts_scaffolds</span><span class="p">:</span>
        <span class="n">cur_dec_pattern</span> <span class="o">=</span> <span class="n">PatternConstraint</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">scaff_temperature</span><span class="p">)</span>
        <span class="n">decorator</span> <span class="o">=</span> <span class="n">PatternSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">cur_dec_pattern</span><span class="p">)</span>
        <span class="n">cur_scaffolds</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">.</span><span class="n">sample_scaffolds</span><span class="p">(</span>
            <span class="n">n_samples</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="p">,</span> <span class="n">n_scaff_samples</span><span class="p">),</span>
            <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">all_scaffolds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cur_scaffolds</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
        <span class="n">all_scaffolds</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_scaffolds</span> <span class="k">if</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">total_sequences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scaff</span> <span class="ow">in</span> <span class="n">all_scaffolds</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">without_rdkit_log</span><span class="p">():</span>
            <span class="n">cur_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion</span><span class="p">(</span>
                <span class="n">fragment</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">scaff</span><span class="p">),</span>
                <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_samples_per_trial</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_scaffolds</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
                <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
                <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
                <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
                <span class="n">add_dot</span><span class="o">=</span><span class="n">add_dot</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">total_sequences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cur_sequences</span><span class="p">)</span>

    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
        <span class="n">total_sequences</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_by_substructure_constraints</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">,</span> <span class="n">scaffold</span><span class="p">)</span>
        <span class="n">total_sequences</span> <span class="o">=</span> <span class="n">total_sequences</span><span class="p">[:</span><span class="n">n_samples_per_trial</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%) generated molecules are valid!&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">total_sequences</span><span class="p">[:</span><span class="n">n_samples_per_trial</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.scaffold_decoration" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">scaffold_decoration</span><span class="p">(</span><span class="n">scaffold</span><span class="p">,</span> <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_dot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.scaffold_decoration" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform scaffold decoration using the pretrained SAFE model</p>
<p>For scaffold decoration, we basically starts with a prefix with the attachment point.
We first convert the prefix into valid safe string.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>scaffold</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>scaffold (with attachment points) to decorate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples_per_trial</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of new molecules to generate for each randomization</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_trials</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of randomization to perform</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>do_not_fragment_further</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to fragment the scaffold further or not</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sanitize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to sanitize the generated molecules and check if the scaffold is still present</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random seed to use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any argument to provide to the underlying generation function</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">scaffold_decoration</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">scaffold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
    <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_dot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform scaffold decoration using the pretrained SAFE model</span>

<span class="sd">    For scaffold decoration, we basically starts with a prefix with the attachment point.</span>
<span class="sd">    We first convert the prefix into valid safe string.</span>

<span class="sd">    Args:</span>
<span class="sd">        scaffold: scaffold (with attachment points) to decorate</span>
<span class="sd">        n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">        n_trials: number of randomization to perform</span>
<span class="sd">        do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">        sanitize: whether to sanitize the generated molecules and check if the scaffold is still present</span>
<span class="sd">        random_seed: random seed to use</span>
<span class="sd">        kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">total_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion</span><span class="p">(</span>
        <span class="n">fragment</span><span class="o">=</span><span class="n">scaffold</span><span class="p">,</span>
        <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="n">add_dot</span><span class="o">=</span><span class="n">add_dot</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># if we require sanitization</span>
    <span class="c1"># then we should filter out molecules that do not match the requested</span>
    <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
        <span class="n">total_sequences</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_by_substructure_constraints</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">,</span> <span class="n">scaffold</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %)  generated molecules are valid !&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">total_sequences</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.scaffold_morphing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">scaffold_morphing</span><span class="p">(</span><span class="n">side_chains</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.scaffold_morphing" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform scaffold morphing decoration using the pretrained SAFE model</p>
<p>For scaffold morphing, we try to replace the core by a new one. If the side_chains are provided, we use them.
If a combination of molecule and core is provided, then, we use them to extract the side chains and performing the
scaffold morphing then.</p>
<div class="admonition note">
<p class="admonition-title">Finding the side chains</p>
<p>The algorithm to find the side chains from core assumes that the core we get as input has attachment points.
Those attachment points are never considered as part of the query, rather they are used to define the attachment points.
See ~sf.utils.compute_side_chains for more information.</p>
</div>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>side_chains</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="datamol.Mol">Mol</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>side chains to use to perform scaffold morphing (joining as best as possible the set of fragments)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="datamol.Mol">Mol</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input molecules when side_chains are not provided</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>core</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="datamol.Mol">Mol</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>core to morph into another scaffold</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples_per_trial</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of new molecules to generate for each randomization</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_trials</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of randomization to perform</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>do_not_fragment_further</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to fragment the scaffold further or not</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sanitize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to sanitize the generated molecules</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random seed to use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any argument to provide to the underlying generation function</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">scaffold_morphing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">side_chains</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">core</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform scaffold morphing decoration using the pretrained SAFE model</span>

<span class="sd">    For scaffold morphing, we try to replace the core by a new one. If the side_chains are provided, we use them.</span>
<span class="sd">    If a combination of molecule and core is provided, then, we use them to extract the side chains and performing the</span>
<span class="sd">    scaffold morphing then.</span>

<span class="sd">    !!! note &quot;Finding the side chains&quot;</span>
<span class="sd">        The algorithm to find the side chains from core assumes that the core we get as input has attachment points.</span>
<span class="sd">        Those attachment points are never considered as part of the query, rather they are used to define the attachment points.</span>
<span class="sd">        See ~sf.utils.compute_side_chains for more information.</span>

<span class="sd">    Args:</span>
<span class="sd">        side_chains: side chains to use to perform scaffold morphing (joining as best as possible the set of fragments)</span>
<span class="sd">        mol: input molecules when side_chains are not provided</span>
<span class="sd">        core: core to morph into another scaffold</span>
<span class="sd">        n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">        n_trials: number of randomization to perform</span>
<span class="sd">        do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">        sanitize: whether to sanitize the generated molecules</span>
<span class="sd">        random_seed: random seed to use</span>
<span class="sd">        kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment_linking</span><span class="p">(</span>
        <span class="n">side_chains</span><span class="o">=</span><span class="n">side_chains</span><span class="p">,</span>
        <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span>
        <span class="n">core</span><span class="o">=</span><span class="n">core</span><span class="p">,</span>
        <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
        <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span>
        <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
        <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="n">is_linking</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.sample.SAFEDesign.super_structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">super_structure</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attachment_point_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.sample.SAFEDesign.super_structure" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform super structure generation using the pretrained SAFE model.</p>
<p>To generate super-structure, we basically just create various attachment points to the input core,
then perform scaffold decoration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>core</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input substructure to use. We aim to generate super structures of this molecule</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples_per_trial</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of new molecules to generate for each randomization</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_trials</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of different attachment points to consider</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>do_not_fragment_further</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to fragment the scaffold further or not</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sanitize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to sanitize the generated molecules</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random seed to use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attachment_point_depth</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>depth of opening the attachment points.
Increasing this, means you increase the number of substitution point to consider.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>any argument to provide to the underlying generation function</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/sample.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">super_structure</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">core</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span>
    <span class="n">n_samples_per_trial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">sanitize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">do_not_fragment_further</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attachment_point_depth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform super structure generation using the pretrained SAFE model.</span>

<span class="sd">    To generate super-structure, we basically just create various attachment points to the input core,</span>
<span class="sd">    then perform scaffold decoration.</span>

<span class="sd">    Args:</span>
<span class="sd">        core: input substructure to use. We aim to generate super structures of this molecule</span>
<span class="sd">        n_samples_per_trial: number of new molecules to generate for each randomization</span>
<span class="sd">        n_trials: number of different attachment points to consider</span>
<span class="sd">        do_not_fragment_further: whether to fragment the scaffold further or not</span>
<span class="sd">        sanitize: whether to sanitize the generated molecules</span>
<span class="sd">        random_seed: random seed to use</span>
<span class="sd">        attachment_point_depth: depth of opening the attachment points.</span>
<span class="sd">            Increasing this, means you increase the number of substitution point to consider.</span>
<span class="sd">        kwargs: any argument to provide to the underlying generation function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">core</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">core</span><span class="p">)</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">list_individual_attach_points</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">attachment_point_depth</span><span class="p">)</span>
    <span class="c1"># get the fully open mol, everytime too.</span>
    <span class="n">cores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">open_attach_points</span><span class="p">(</span><span class="n">core</span><span class="p">)))</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cores</span><span class="p">))</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">cores</span><span class="p">)</span>
    <span class="c1"># now also get the single openining of an attachment point</span>
    <span class="n">total_sequences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_trials</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">core</span> <span class="o">=</span> <span class="n">cores</span><span class="p">[</span><span class="n">_</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cores</span><span class="p">)]</span>
        <span class="n">old_verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">sf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion</span><span class="p">(</span>
                    <span class="n">fragment</span><span class="o">=</span><span class="n">core</span><span class="p">,</span>
                    <span class="n">n_samples_per_trial</span><span class="o">=</span><span class="n">n_samples_per_trial</span><span class="p">,</span>
                    <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">do_not_fragment_further</span><span class="o">=</span><span class="n">do_not_fragment_further</span><span class="p">,</span>
                    <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">,</span>
                    <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">total_sequences</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">old_verbose</span>

    <span class="k">if</span> <span class="n">sanitize</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;After sanitization, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_sequences</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">n_samples_per_trial</span><span class="o">*</span><span class="n">n_trials</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %)  generated molecules are valid !&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">total_sequences</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />
<h2 id="safe-tokenizer">SAFE Tokenizer<a class="headerlink" href="#safe-tokenizer" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="safe.tokenizer"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="safe.tokenizer.SAFESplitter" class="doc doc-heading">
            <code>SAFESplitter</code>


<a href="#safe.tokenizer.SAFESplitter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Standard Splitter for SAFE string</p>






              <details class="quote">
                <summary>Source code in <code>safe/tokenizer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SAFESplitter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard Splitter for SAFE string&quot;&quot;&quot;</span>

    <span class="n">REGEX_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;(\[[^\]]+]|Br?|Cl?|N|O|S|P|F|I|b|c|n|o|s|p|\(|\)|\.|=|#|-|\+|\\|\/|:|~|@|\?|&gt;&gt;?|\*|\$|\%[0-9]</span><span class="si">{2}</span><span class="s2">|[0-9])&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;safe&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># do not use this as raw strings (not r before)</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REGEX_PATTERN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize a safe string into characters.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="n">reconstruction</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="n">reconstruction</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tokens different from sample:</span><span class="se">\n</span><span class="s2">tokens </span><span class="si">{</span><span class="n">reconstruction</span><span class="si">}</span><span class="se">\n</span><span class="s2">sample </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">detokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detokenize SAFE notation&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="n">chars</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">normalized</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform splitting for pretokenization&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pre_tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretok</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pretokenize using an input pretokenizer object from the tokenizer library&quot;&quot;&quot;</span>
        <span class="n">pretok</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFESplitter.detokenize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">detokenize</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFESplitter.detokenize" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Detokenize SAFE notation</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">detokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detokenize SAFE notation&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="n">chars</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFESplitter.pre_tokenize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pre_tokenize</span><span class="p">(</span><span class="n">pretok</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFESplitter.pre_tokenize" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Pretokenize using an input pretokenizer object from the tokenizer library</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pre_tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretok</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pretokenize using an input pretokenizer object from the tokenizer library&quot;&quot;&quot;</span>
    <span class="n">pretok</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFESplitter.split" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">normalized</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFESplitter.split" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform splitting for pretokenization</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">normalized</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform splitting for pretokenization&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFESplitter.tokenize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tokenize</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFESplitter.tokenize" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Tokenize a safe string into characters.</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tokenize a safe string into characters.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">reconstruction</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="n">reconstruction</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Tokens different from sample:</span><span class="se">\n</span><span class="s2">tokens </span><span class="si">{</span><span class="n">reconstruction</span><span class="si">}</span><span class="se">\n</span><span class="s2">sample </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tokens</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="safe.tokenizer.SAFETokenizer" class="doc doc-heading">
            <code>SAFETokenizer</code>


<a href="#safe.tokenizer.SAFETokenizer" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="transformers.utils.PushToHubMixin">PushToHubMixin</span></code></p>


        <p>Class to initialize and train a tokenizer for SAFE string
Once trained, you can use the converted version of the tokenizer to an HuggingFace PreTrainedTokenizerFast</p>






              <details class="quote">
                <summary>Source code in <code>safe/tokenizer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SAFETokenizer</span><span class="p">(</span><span class="n">PushToHubMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to initialize and train a tokenizer for SAFE string</span>
<span class="sd">    Once trained, you can use the converted version of the tokenizer to an HuggingFace PreTrainedTokenizerFast</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vocab_files_names</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tokenizer.json&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tokenizer_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bpe&quot;</span><span class="p">,</span>
        <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;safe&quot;</span><span class="p">,</span>
        <span class="n">trainer_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">decoder_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">token_model_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span> <span class="o">=</span> <span class="n">tokenizer_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer_args</span> <span class="o">=</span> <span class="n">trainer_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_args</span> <span class="o">=</span> <span class="n">decoder_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_model_args</span> <span class="o">=</span> <span class="n">token_model_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">tokenizer_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tokenizer_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bpe&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">BPE</span><span class="p">(</span><span class="n">unk_token</span><span class="o">=</span><span class="n">UNK_TOKEN</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">token_model_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">BpeTrainer</span><span class="p">(</span><span class="n">special_tokens</span><span class="o">=</span><span class="n">SPECIAL_TOKENS</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer_args</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">WordLevel</span><span class="p">(</span><span class="n">unk_token</span><span class="o">=</span><span class="n">UNK_TOKEN</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">token_model_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">WordLevelTrainer</span><span class="p">(</span><span class="n">special_tokens</span><span class="o">=</span><span class="n">SPECIAL_TOKENS</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">splitter</span> <span class="o">==</span> <span class="s2">&quot;safe&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="n">SAFESplitter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="n">PreTokenizer</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">post_processor</span> <span class="o">=</span> <span class="n">TemplateProcessing</span><span class="p">(</span>
            <span class="n">single</span><span class="o">=</span><span class="n">TEMPLATE_SINGLE</span><span class="p">,</span>
            <span class="n">pair</span><span class="o">=</span><span class="n">TEMPLATE_PAIR</span><span class="p">,</span>
            <span class="n">special_tokens</span><span class="o">=</span><span class="n">TEMPLATE_SPECIAL_TOKENS</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoders</span><span class="o">.</span><span class="n">BPEDecoder</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_special_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bos_token_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the bos token id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pad_token_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the pad token id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eos_token_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the eos token id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unk_token_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the unk token id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mask_token_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the mask token id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">mask_token</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cls_token_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the cls token id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">cls_token</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sep_token_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the sep token id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">sep_token</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_special_tokens</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span><span class="p">,</span>
        <span class="n">bos_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CLS_TOKEN</span><span class="p">,</span>
        <span class="n">eos_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">SEP_TOKEN</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set special tokens for a tokenizer</span>

<span class="sd">        Args:</span>
<span class="sd">            tokenizer: tokenizer for which special tokens will be set</span>
<span class="sd">            bos_token: Optional bos token to use</span>
<span class="sd">            eos_token: Optional eos token to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">PADDING_TOKEN</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">cls_token</span> <span class="o">=</span> <span class="n">CLS_TOKEN</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">sep_token</span> <span class="o">=</span> <span class="n">SEP_TOKEN</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">mask_token</span> <span class="o">=</span> <span class="n">MASK_TOKEN</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span> <span class="o">=</span> <span class="n">UNK_TOKEN</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span> <span class="o">=</span> <span class="n">eos_token</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token</span> <span class="o">=</span> <span class="n">bos_token</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">Tokenizer</span><span class="p">):</span>
            <span class="n">tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">PADDING_TOKEN</span><span class="p">,</span>
                    <span class="n">CLS_TOKEN</span><span class="p">,</span>
                    <span class="n">SEP_TOKEN</span><span class="p">,</span>
                    <span class="n">MASK_TOKEN</span><span class="p">,</span>
                    <span class="n">UNK_TOKEN</span><span class="p">,</span>
                    <span class="n">eos_token</span><span class="p">,</span>
                    <span class="n">bos_token</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">tokenizer</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is to train a new tokenizer from either a list of file or some input data</span>

<span class="sd">        Args</span>
<span class="sd">            files (str): file in which your molecules are separated by new line</span>
<span class="sd">            kwargs (dict): optional args for the tokenizer `train`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">trainer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Getting state to allow pickling&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;pre_tokenizer&quot;</span><span class="p">,</span> <span class="n">Whitespace</span><span class="p">()):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="c1"># copy back tokenizer level attribute</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tokenizer_attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="n">Whitespace</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setting state during reloading pickling&quot;&quot;&quot;</span>
        <span class="n">use_pretokenizer</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom_pre_tokenizer&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_pretokenizer</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="n">PreTokenizer</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SAFESplitter</span><span class="p">())</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tokenizer_attrs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_from_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the Tokenizer using the provided iterator.</span>

<span class="sd">        You can provide anything that is a Python Iterator</span>
<span class="sd">            * A list of sequences :obj:`List[str]`</span>
<span class="sd">            * A generator that yields :obj:`str` or :obj:`List[str]`</span>
<span class="sd">            * A Numpy array of strings</span>

<span class="sd">        Args:</span>
<span class="sd">            data: data iterator</span>
<span class="sd">            **kwargs: additional keyword argument for the tokenizer `train_from_iterator`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">train_from_iterator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">trainer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the count of tokens in vocab along with special tokens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">get_vocab</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ids_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encodes a given molecule string once training is done</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_str: Sample string to encode molecule</span>
<span class="sd">            ids_only: whether to return only the ids or the encoding objet</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: Returns encoded list of IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sample_str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ids_only</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">enc</span><span class="o">.</span><span class="n">ids</span>
            <span class="k">return</span> <span class="n">enc</span>

        <span class="n">encs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode_batch</span><span class="p">(</span><span class="n">sample_str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ids_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">enc</span><span class="o">.</span><span class="n">ids</span> <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">encs</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert tokenizer to dict&quot;&quot;&quot;</span>
        <span class="c1"># we need to do this because HuggingFace tokenizers doesnt save with custom pre-tokenizers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tk_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">to_str</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;pre_tokenizer&quot;</span><span class="p">,</span> <span class="n">Whitespace</span><span class="p">()):</span>
                <span class="c1"># temporary replace pre tokenizer with whitespace</span>
                <span class="n">tk_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">to_str</span><span class="p">())</span>
                <span class="n">tk_data</span><span class="p">[</span><span class="s2">&quot;custom_pre_tokenizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tk_data</span><span class="p">[</span><span class="s2">&quot;tokenizer_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span>
        <span class="n">tk_data</span><span class="p">[</span><span class="s2">&quot;tokenizer_attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">return</span> <span class="n">tk_data</span>

    <span class="k">def</span> <span class="nf">save_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save pretrained tokenizer&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the :class:`~tokenizers.Tokenizer` to the file at the given path.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_name (str, optional): File where to save tokenizer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># EN: whole logic here assumes noone is going to mess with the special token</span>
        <span class="n">tk_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">OUT</span><span class="p">:</span>
            <span class="n">out_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tk_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">OUT</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load tokenizer from dict</span>

<span class="sd">        Args:</span>
<span class="sd">            data: dictionary containing the tokenizer info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokenizer_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tokenizer_type&quot;</span><span class="p">,</span> <span class="s2">&quot;safe&quot;</span><span class="p">)</span>
        <span class="n">tokenizer_attrs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tokenizer_attrs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">custom_pre_tokenizer</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;custom_pre_tokenizer&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">custom_pre_tokenizer</span><span class="p">:</span>
            <span class="n">tokenizer</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="n">PreTokenizer</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SAFESplitter</span><span class="p">())</span>
        <span class="n">mol_tokenizer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tokenizer_type</span><span class="p">)</span>
        <span class="n">mol_tokenizer</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">mol_tokenizer</span><span class="o">.</span><span class="n">set_special_tokens</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tokenizer_attrs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokenizer_attrs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">mol_tokenizer</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tokenizer_attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mol_tokenizer</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the current tokenizer from file&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">OUT</span><span class="p">:</span>
            <span class="n">data_str</span> <span class="o">=</span> <span class="n">OUT</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data_str</span><span class="p">)</span>
        <span class="c1"># EN: the rust json parser of tokenizers has a predefined structure</span>
        <span class="c1"># the next two lines are important</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">skip_special_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_stops</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">stop_token_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decodes a list of ids to molecular representation in the format in which this tokenizer was created.</span>

<span class="sd">        Args:</span>
<span class="sd">            ids: list of IDs</span>
<span class="sd">            skip_special_tokens: whether to skip all special tokens when encountering them</span>
<span class="sd">            ignore_stops: whether to ignore the stop tokens, thus decoding till the end</span>
<span class="sd">            stop_token_ids: optional list of stop token ids to use</span>

<span class="sd">        Returns:</span>
<span class="sd">            sequence: str representation of molecule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_id_list</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">old_id_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stop_token_ids</span><span class="p">:</span>
            <span class="n">stop_token_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span><span class="p">)]</span>

        <span class="n">new_ids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">old_id_list</span><span class="p">:</span>
            <span class="n">new_ids</span> <span class="o">=</span> <span class="n">ids</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_stops</span><span class="p">:</span>
                <span class="n">new_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># if first tokens are stop, we just remove it</span>
                <span class="c1"># this is because of bart essentially</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">ids</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">stop_token_ids</span><span class="p">:</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># we only ignore when there is a list of tokens</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span>
                <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">stop_token_ids</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">new_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="n">new_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_ids_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">new_ids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="n">skip_special_tokens</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode_batch</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">new_ids_list</span><span class="p">),</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="n">skip_special_tokens</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedTokenizerFast</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a pretrained tokenizer from this tokenizer</span>

<span class="sd">        Returns:</span>
<span class="sd">            Returns pre-trained fast tokenizer for hugging face models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;pre_tokenizer&quot;</span><span class="p">,</span> <span class="n">Whitespace</span><span class="p">()):</span>
            <span class="n">tk</span> <span class="o">=</span> <span class="n">PreTrainedTokenizerFast</span><span class="p">(</span><span class="n">tokenizer_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">_tokenizer</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pre_tokenizer</span>
        <span class="c1"># now we need to add special_tokens</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cls_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">cls_token</span><span class="p">,</span>
                <span class="s2">&quot;bos_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token</span><span class="p">,</span>
                <span class="s2">&quot;eos_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span><span class="p">,</span>
                <span class="s2">&quot;mask_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">mask_token</span><span class="p">,</span>
                <span class="s2">&quot;pad_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span>
                <span class="s2">&quot;unk_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span><span class="p">,</span>
                <span class="s2">&quot;sep_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">sep_token</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">tk</span><span class="o">.</span><span class="n">model_max_length</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">tk</span><span class="o">.</span><span class="n">model_max_length</span> <span class="o">&gt;</span> <span class="mf">1e8</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;model_max_length&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">tk</span><span class="o">.</span><span class="n">model_max_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="n">tk</span><span class="p">,</span>
                <span class="s2">&quot;model_max_length&quot;</span><span class="p">,</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;model_max_length&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">tk</span>

    <span class="k">def</span> <span class="nf">push_to_hub</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_temp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">commit_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">private</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_shard_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;10GB&quot;</span><span class="p">,</span>
        <span class="n">create_pr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">safe_serialization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">deprecated_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload the tokenizer to the 🤗 Model Hub.</span>

<span class="sd">        Args:</span>
<span class="sd">            repo_id: The name of the repository you want to push your {object} to. It should contain your organization name</span>
<span class="sd">                when pushing to a given organization.</span>
<span class="sd">            use_temp_dir: Whether or not to use a temporary directory to store the files saved before they are pushed to the Hub.</span>
<span class="sd">                Will default to `True` if there is no directory named like `repo_id`, `False` otherwise.</span>
<span class="sd">            commit_message: Message to commit while pushing. Will default to `&quot;Upload {object}&quot;`.</span>
<span class="sd">            private: Whether or not the repository created should be private.</span>
<span class="sd">            token: The token to use as HTTP bearer authorization for remote files. If `True`, will use the token generated</span>
<span class="sd">                when running `huggingface-cli login` (stored in `~/.huggingface`). Will default to `True` if `repo_url`</span>
<span class="sd">                is not specified.</span>
<span class="sd">            max_shard_size: Only applicable for models. The maximum size for a checkpoint before being sharded. Checkpoints shard</span>
<span class="sd">                will then be each of size lower than this size. If expressed as a string, needs to be digits followed</span>
<span class="sd">                by a unit (like `&quot;5MB&quot;`).</span>
<span class="sd">            create_pr: Whether or not to create a PR with the uploaded files or directly commit.</span>
<span class="sd">            safe_serialization: Whether or not to convert the model weights in safetensors format for safer serialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_auth_token</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_auth_token&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_auth_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The `use_auth_token` argument is deprecated and will be removed in v5 of Transformers.&quot;</span><span class="p">,</span>
                <span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`token` and `use_auth_token` are both specified. Please set only the argument `token`.&quot;</span>
                <span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">use_auth_token</span>

        <span class="n">repo_path_or_name</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repo_path_or_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">repo_path_or_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Should use `repo_id` instead of `repo_path_or_name`. When using `repo_path_or_name`, we try to infer</span>
            <span class="c1"># repo_id from the folder path, if it exists.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The `repo_path_or_name` argument is deprecated and will be removed in v5 of Transformers. Use &quot;</span>
                <span class="s2">&quot;`repo_id` instead.&quot;</span><span class="p">,</span>
                <span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">repo_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`repo_id` and `repo_path_or_name` are both specified. Please set only the argument `repo_id`.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">):</span>
                <span class="c1"># repo_path: infer repo_id from the path</span>
                <span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">working_dir</span> <span class="o">=</span> <span class="n">repo_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># repo_name: use it as repo_id</span>
                <span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_path_or_name</span>
                <span class="n">working_dir</span> <span class="o">=</span> <span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Repo_id is passed correctly: infer working_dir from it</span>
            <span class="n">working_dir</span> <span class="o">=</span> <span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Deprecation warning will be sent after for repo_url and organization</span>
        <span class="n">repo_url</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repo_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">organization</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;organization&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">repo_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_repo</span><span class="p">(</span>
            <span class="n">repo_id</span><span class="p">,</span> <span class="n">private</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">repo_url</span><span class="o">=</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">organization</span><span class="o">=</span><span class="n">organization</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_temp_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_temp_dir</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">working_or_temp_dir</span><span class="p">(</span><span class="n">working_dir</span><span class="o">=</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">use_temp_dir</span><span class="o">=</span><span class="n">use_temp_dir</span><span class="p">)</span> <span class="k">as</span> <span class="n">work_dir</span><span class="p">:</span>
            <span class="n">files_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_files_timestamps</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>

            <span class="c1"># Save all files.</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span>
                    <span class="n">work_dir</span><span class="p">,</span> <span class="n">max_shard_size</span><span class="o">=</span><span class="n">max_shard_size</span><span class="p">,</span> <span class="n">safe_serialization</span><span class="o">=</span><span class="n">safe_serialization</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_files_names</span><span class="p">))</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_modified_files</span><span class="p">(</span>
                <span class="n">work_dir</span><span class="p">,</span>
                <span class="n">repo_id</span><span class="p">,</span>
                <span class="n">files_timestamps</span><span class="p">,</span>
                <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">,</span>
                <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
                <span class="n">create_pr</span><span class="o">=</span><span class="n">create_pr</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pretrained</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">pretrained_model_name_or_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">local_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_fast_tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate a [`~tokenization_utils_base.PreTrainedTokenizerBase`] (or a derived class) from a predefined</span>
<span class="sd">        tokenizer.</span>

<span class="sd">        Args:</span>
<span class="sd">            pretrained_model_name_or_path:</span>
<span class="sd">                Can be either:</span>

<span class="sd">                - A string, the *model id* of a predefined tokenizer hosted inside a model repo on huggingface.co.</span>
<span class="sd">                  Valid model ids can be located at the root-level, like `bert-base-uncased`, or namespaced under a</span>
<span class="sd">                  user or organization name, like `dbmdz/bert-base-german-cased`.</span>
<span class="sd">                - A path to a *directory* containing vocabulary files required by the tokenizer, for instance saved</span>
<span class="sd">                  using the [`~tokenization_utils_base.PreTrainedTokenizerBase.save_pretrained`] method, e.g.,</span>
<span class="sd">                  `./my_model_directory/`.</span>
<span class="sd">                - (**Deprecated**, not applicable to all derived classes) A path or url to a single saved vocabulary</span>
<span class="sd">                  file (if and only if the tokenizer only requires a single vocabulary file like Bert or XLNet), e.g.,</span>
<span class="sd">                  `./my_model_directory/vocab.txt`.</span>
<span class="sd">            cache_dir: Path to a directory in which a downloaded predefined tokenizer vocabulary files should be cached if the</span>
<span class="sd">                standard cache should not be used.</span>
<span class="sd">            force_download: Whether or not to force the (re-)download the vocabulary files and override the cached versions if they exist.</span>
<span class="sd">            proxies: A dictionary of proxy servers to use by protocol or endpoint, e.g.,</span>
<span class="sd">                `{&#39;http&#39;: &#39;foo.bar:3128&#39;, &#39;http://hostname&#39;: &#39;foo.bar:4012&#39;}`. The proxies are used on each request.</span>
<span class="sd">            token: The token to use as HTTP bearer authorization for remote files.</span>
<span class="sd">                If `True`, will use the token generated when running `huggingface-cli login` (stored in `~/.huggingface`).</span>
<span class="sd">            local_files_only: Whether or not to only rely on local files and not to attempt to download any files.</span>
<span class="sd">            return_fast_tokenizer: Whether to return fast tokenizer or not.</span>

<span class="sd">        Examples:</span>
<span class="sd">        ``` py</span>
<span class="sd">            # We can&#39;t instantiate directly the base class *PreTrainedTokenizerBase* so let&#39;s show our examples on a derived class: BertTokenizer</span>
<span class="sd">            # Download vocabulary from huggingface.co and cache.</span>
<span class="sd">            tokenizer = SAFETokenizer.from_pretrained(&quot;datamol-io/safe-gpt&quot;)</span>

<span class="sd">            # If vocabulary files are in a directory (e.g. tokenizer was saved using *save_pretrained(&#39;./test/saved_model/&#39;)*)</span>
<span class="sd">            tokenizer = SAFETokenizer.from_pretrained(&quot;./test/saved_model/&quot;)</span>

<span class="sd">            # If the tokenizer uses a single vocabulary file, you can point directly to this file</span>
<span class="sd">            tokenizer = BertTokenizer.from_pretrained(&quot;./test/saved_model/tokenizer.json&quot;)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resume_download</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;resume_download&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">use_auth_token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_auth_token&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">subfolder</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;subfolder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">from_pipeline</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_from_pipeline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">from_auto_class</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_from_auto&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">commit_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_commit_hash&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_auth_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The `use_auth_token` argument is deprecated and will be removed in v5 of Transformers.&quot;</span><span class="p">,</span>
                <span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`token` and `use_auth_token` are both specified. Please set only the argument `token`.&quot;</span>
                <span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">use_auth_token</span>

        <span class="n">user_agent</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;file_type&quot;</span><span class="p">:</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from_auto_class&quot;</span><span class="p">:</span> <span class="n">from_auto_class</span><span class="p">,</span>
            <span class="s2">&quot;is_fast&quot;</span><span class="p">:</span> <span class="s2">&quot;Fast&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">from_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user_agent</span><span class="p">[</span><span class="s2">&quot;using_pipeline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_pipeline</span>

        <span class="k">if</span> <span class="n">is_offline_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">local_files_only</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Offline mode: forcing local_files_only=True&quot;</span><span class="p">)</span>
            <span class="n">local_files_only</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">pretrained_model_name_or_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">pretrained_model_name_or_path</span>
        <span class="k">elif</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">download_url</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># EN: remove this when transformers package has uniform API</span>
            <span class="n">cached_file_extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;use_auth_token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">transformers_version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;5.0&quot;</span><span class="p">):</span>
                <span class="n">cached_file_extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">}</span>
            <span class="c1"># Try to get the tokenizer config to see if there are versioned tokenizer files.</span>
            <span class="n">resolved_vocab_files</span> <span class="o">=</span> <span class="n">cached_file</span><span class="p">(</span>
                <span class="n">pretrained_model_name_or_path</span><span class="p">,</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">vocab_files_names</span><span class="p">,</span>
                <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
                <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
                <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
                <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
                <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
                <span class="n">subfolder</span><span class="o">=</span><span class="n">subfolder</span><span class="p">,</span>
                <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
                <span class="n">_raise_exceptions_for_missing_entries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">_raise_exceptions_for_connection_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">_commit_hash</span><span class="o">=</span><span class="n">commit_hash</span><span class="p">,</span>
                <span class="o">**</span><span class="n">cached_file_extra_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">commit_hash</span> <span class="o">=</span> <span class="n">extract_commit_hash</span><span class="p">(</span><span class="n">resolved_vocab_files</span><span class="p">,</span> <span class="n">commit_hash</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">resolved_vocab_files</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Can&#39;t load the following file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> required for loading the tokenizer&quot;</span>
            <span class="p">)</span>

        <span class="n">tokenizer</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_fast_tokenizer</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">get_pretrained</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tokenizer</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="safe.tokenizer.SAFETokenizer.bos_token_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">bos_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.bos_token_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the bos token id</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="safe.tokenizer.SAFETokenizer.cls_token_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cls_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.cls_token_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the cls token id</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="safe.tokenizer.SAFETokenizer.eos_token_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">eos_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.eos_token_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the eos token id</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="safe.tokenizer.SAFETokenizer.mask_token_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mask_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.mask_token_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the mask token id</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="safe.tokenizer.SAFETokenizer.pad_token_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pad_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.pad_token_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the pad token id</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="safe.tokenizer.SAFETokenizer.sep_token_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sep_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.sep_token_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the sep token id</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="safe.tokenizer.SAFETokenizer.unk_token_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">unk_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.unk_token_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the unk token id</p>
    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.__getstate__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__getstate__</span><span class="p">()</span></code>

<a href="#safe.tokenizer.SAFETokenizer.__getstate__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Getting state to allow pickling</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Getting state to allow pickling&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;pre_tokenizer&quot;</span><span class="p">,</span> <span class="n">Whitespace</span><span class="p">()):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="c1"># copy back tokenizer level attribute</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tokenizer_attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="n">Whitespace</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">d</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.__len__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

<a href="#safe.tokenizer.SAFETokenizer.__len__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Gets the count of tokens in vocab along with special tokens.</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the count of tokens in vocab along with special tokens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">get_vocab</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.__setstate__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__setstate__</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.__setstate__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Setting state during reloading pickling</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setting state during reloading pickling&quot;&quot;&quot;</span>
    <span class="n">use_pretokenizer</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom_pre_tokenizer&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_pretokenizer</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="n">PreTokenizer</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SAFESplitter</span><span class="p">())</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tokenizer_attrs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.decode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">decode</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_stops</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stop_token_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.decode" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Decodes a list of ids to molecular representation in the format in which this tokenizer was created.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ids</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of IDs</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_special_tokens</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to skip all special tokens when encountering them</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_stops</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to ignore the stop tokens, thus decoding till the end</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stop_token_ids</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional list of stop token ids to use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>sequence</code></td>            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str representation of molecule</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">skip_special_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ignore_stops</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">stop_token_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decodes a list of ids to molecular representation in the format in which this tokenizer was created.</span>

<span class="sd">    Args:</span>
<span class="sd">        ids: list of IDs</span>
<span class="sd">        skip_special_tokens: whether to skip all special tokens when encountering them</span>
<span class="sd">        ignore_stops: whether to ignore the stop tokens, thus decoding till the end</span>
<span class="sd">        stop_token_ids: optional list of stop token ids to use</span>

<span class="sd">    Returns:</span>
<span class="sd">        sequence: str representation of molecule</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_id_list</span> <span class="o">=</span> <span class="n">ids</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">old_id_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stop_token_ids</span><span class="p">:</span>
        <span class="n">stop_token_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span><span class="p">)]</span>

    <span class="n">new_ids_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">old_id_list</span><span class="p">:</span>
        <span class="n">new_ids</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_stops</span><span class="p">:</span>
            <span class="n">new_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># if first tokens are stop, we just remove it</span>
            <span class="c1"># this is because of bart essentially</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">ids</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">stop_token_ids</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># we only ignore when there is a list of tokens</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">stop_token_ids</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">new_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">new_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_ids_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">new_ids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="n">skip_special_tokens</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode_batch</span><span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">new_ids_list</span><span class="p">),</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="n">skip_special_tokens</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.encode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">encode</span><span class="p">(</span><span class="n">sample_str</span><span class="p">,</span> <span class="n">ids_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.encode" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Encodes a given molecule string once training is done</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sample_str</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sample string to encode molecule</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ids_only</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to return only the ids or the encoding objet</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>object</code></td>            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Returns encoded list of IDs</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ids_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encodes a given molecule string once training is done</span>

<span class="sd">    Args:</span>
<span class="sd">        sample_str: Sample string to encode molecule</span>
<span class="sd">        ids_only: whether to return only the ids or the encoding objet</span>

<span class="sd">    Returns:</span>
<span class="sd">        object: Returns encoded list of IDs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sample_str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ids_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">enc</span><span class="o">.</span><span class="n">ids</span>
        <span class="k">return</span> <span class="n">enc</span>

    <span class="n">encs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode_batch</span><span class="p">(</span><span class="n">sample_str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ids_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">enc</span><span class="o">.</span><span class="n">ids</span> <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">encs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.from_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.from_dict" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Load tokenizer from dict</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary containing the tokenizer info</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load tokenizer from dict</span>

<span class="sd">    Args:</span>
<span class="sd">        data: dictionary containing the tokenizer info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tokenizer_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tokenizer_type&quot;</span><span class="p">,</span> <span class="s2">&quot;safe&quot;</span><span class="p">)</span>
    <span class="n">tokenizer_attrs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tokenizer_attrs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">custom_pre_tokenizer</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;custom_pre_tokenizer&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">custom_pre_tokenizer</span><span class="p">:</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="n">PreTokenizer</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SAFESplitter</span><span class="p">())</span>
    <span class="n">mol_tokenizer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tokenizer_type</span><span class="p">)</span>
    <span class="n">mol_tokenizer</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">mol_tokenizer</span><span class="o">.</span><span class="n">set_special_tokens</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tokenizer_attrs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokenizer_attrs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">mol_tokenizer</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tokenizer_attrs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mol_tokenizer</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.from_pretrained" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">local_files_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_fast_tokenizer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.from_pretrained" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Instantiate a [<code>~tokenization_utils_base.PreTrainedTokenizerBase</code>] (or a derived class) from a predefined
tokenizer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pretrained_model_name_or_path</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="os.PathLike" href="https://docs.python.org/3/library/os.html#os.PathLike">PathLike</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Can be either:</p>
<ul>
<li>A string, the <em>model id</em> of a predefined tokenizer hosted inside a model repo on huggingface.co.
  Valid model ids can be located at the root-level, like <code>bert-base-uncased</code>, or namespaced under a
  user or organization name, like <code>dbmdz/bert-base-german-cased</code>.</li>
<li>A path to a <em>directory</em> containing vocabulary files required by the tokenizer, for instance saved
  using the [<code>~tokenization_utils_base.PreTrainedTokenizerBase.save_pretrained</code>] method, e.g.,
  <code>./my_model_directory/</code>.</li>
<li>(<strong>Deprecated</strong>, not applicable to all derived classes) A path or url to a single saved vocabulary
  file (if and only if the tokenizer only requires a single vocabulary file like Bert or XLNet), e.g.,
  <code>./my_model_directory/vocab.txt</code>.</li>
</ul>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache_dir</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="os.PathLike" href="https://docs.python.org/3/library/os.html#os.PathLike">PathLike</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to a directory in which a downloaded predefined tokenizer vocabulary files should be cached if the
standard cache should not be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_download</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to force the (re-)download the vocabulary files and override the cached versions if they exist.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>proxies</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of proxy servers to use by protocol or endpoint, e.g.,
<code>{'http': 'foo.bar:3128', 'http://hostname': 'foo.bar:4012'}</code>. The proxies are used on each request.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token to use as HTTP bearer authorization for remote files.
If <code>True</code>, will use the token generated when running <code>huggingface-cli login</code> (stored in <code>~/.huggingface</code>).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>local_files_only</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to only rely on local files and not to attempt to download any files.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_fast_tokenizer</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to return fast tokenizer or not.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    
        <div class="highlight"><pre><span></span><code>    <span class="c1"># We can&#39;t instantiate directly the base class *PreTrainedTokenizerBase* so let&#39;s show our examples on a derived class: BertTokenizer</span>
    <span class="c1"># Download vocabulary from huggingface.co and cache.</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SAFETokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;datamol-io/safe-gpt&quot;</span><span class="p">)</span>

    <span class="c1"># If vocabulary files are in a directory (e.g. tokenizer was saved using *save_pretrained(&#39;./test/saved_model/&#39;)*)</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SAFETokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;./test/saved_model/&quot;</span><span class="p">)</span>

    <span class="c1"># If the tokenizer uses a single vocabulary file, you can point directly to this file</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;./test/saved_model/tokenizer.json&quot;</span><span class="p">)</span>
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_pretrained</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">pretrained_model_name_or_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
    <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">force_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">local_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_fast_tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate a [`~tokenization_utils_base.PreTrainedTokenizerBase`] (or a derived class) from a predefined</span>
<span class="sd">    tokenizer.</span>

<span class="sd">    Args:</span>
<span class="sd">        pretrained_model_name_or_path:</span>
<span class="sd">            Can be either:</span>

<span class="sd">            - A string, the *model id* of a predefined tokenizer hosted inside a model repo on huggingface.co.</span>
<span class="sd">              Valid model ids can be located at the root-level, like `bert-base-uncased`, or namespaced under a</span>
<span class="sd">              user or organization name, like `dbmdz/bert-base-german-cased`.</span>
<span class="sd">            - A path to a *directory* containing vocabulary files required by the tokenizer, for instance saved</span>
<span class="sd">              using the [`~tokenization_utils_base.PreTrainedTokenizerBase.save_pretrained`] method, e.g.,</span>
<span class="sd">              `./my_model_directory/`.</span>
<span class="sd">            - (**Deprecated**, not applicable to all derived classes) A path or url to a single saved vocabulary</span>
<span class="sd">              file (if and only if the tokenizer only requires a single vocabulary file like Bert or XLNet), e.g.,</span>
<span class="sd">              `./my_model_directory/vocab.txt`.</span>
<span class="sd">        cache_dir: Path to a directory in which a downloaded predefined tokenizer vocabulary files should be cached if the</span>
<span class="sd">            standard cache should not be used.</span>
<span class="sd">        force_download: Whether or not to force the (re-)download the vocabulary files and override the cached versions if they exist.</span>
<span class="sd">        proxies: A dictionary of proxy servers to use by protocol or endpoint, e.g.,</span>
<span class="sd">            `{&#39;http&#39;: &#39;foo.bar:3128&#39;, &#39;http://hostname&#39;: &#39;foo.bar:4012&#39;}`. The proxies are used on each request.</span>
<span class="sd">        token: The token to use as HTTP bearer authorization for remote files.</span>
<span class="sd">            If `True`, will use the token generated when running `huggingface-cli login` (stored in `~/.huggingface`).</span>
<span class="sd">        local_files_only: Whether or not to only rely on local files and not to attempt to download any files.</span>
<span class="sd">        return_fast_tokenizer: Whether to return fast tokenizer or not.</span>

<span class="sd">    Examples:</span>
<span class="sd">    ``` py</span>
<span class="sd">        # We can&#39;t instantiate directly the base class *PreTrainedTokenizerBase* so let&#39;s show our examples on a derived class: BertTokenizer</span>
<span class="sd">        # Download vocabulary from huggingface.co and cache.</span>
<span class="sd">        tokenizer = SAFETokenizer.from_pretrained(&quot;datamol-io/safe-gpt&quot;)</span>

<span class="sd">        # If vocabulary files are in a directory (e.g. tokenizer was saved using *save_pretrained(&#39;./test/saved_model/&#39;)*)</span>
<span class="sd">        tokenizer = SAFETokenizer.from_pretrained(&quot;./test/saved_model/&quot;)</span>

<span class="sd">        # If the tokenizer uses a single vocabulary file, you can point directly to this file</span>
<span class="sd">        tokenizer = BertTokenizer.from_pretrained(&quot;./test/saved_model/tokenizer.json&quot;)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resume_download</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;resume_download&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">use_auth_token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_auth_token&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">subfolder</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;subfolder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">from_pipeline</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_from_pipeline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">from_auto_class</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_from_auto&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">commit_hash</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_commit_hash&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_auth_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The `use_auth_token` argument is deprecated and will be removed in v5 of Transformers.&quot;</span><span class="p">,</span>
            <span class="ne">FutureWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`token` and `use_auth_token` are both specified. Please set only the argument `token`.&quot;</span>
            <span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">use_auth_token</span>

    <span class="n">user_agent</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;file_type&quot;</span><span class="p">:</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from_auto_class&quot;</span><span class="p">:</span> <span class="n">from_auto_class</span><span class="p">,</span>
        <span class="s2">&quot;is_fast&quot;</span><span class="p">:</span> <span class="s2">&quot;Fast&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">from_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_agent</span><span class="p">[</span><span class="s2">&quot;using_pipeline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_pipeline</span>

    <span class="k">if</span> <span class="n">is_offline_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">local_files_only</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Offline mode: forcing local_files_only=True&quot;</span><span class="p">)</span>
        <span class="n">local_files_only</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">pretrained_model_name_or_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">pretrained_model_name_or_path</span>
    <span class="k">elif</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">download_url</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># EN: remove this when transformers package has uniform API</span>
        <span class="n">cached_file_extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;use_auth_token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">transformers_version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;5.0&quot;</span><span class="p">):</span>
            <span class="n">cached_file_extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">}</span>
        <span class="c1"># Try to get the tokenizer config to see if there are versioned tokenizer files.</span>
        <span class="n">resolved_vocab_files</span> <span class="o">=</span> <span class="n">cached_file</span><span class="p">(</span>
            <span class="n">pretrained_model_name_or_path</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">vocab_files_names</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
            <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
            <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
            <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
            <span class="n">subfolder</span><span class="o">=</span><span class="n">subfolder</span><span class="p">,</span>
            <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
            <span class="n">_raise_exceptions_for_missing_entries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">_raise_exceptions_for_connection_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">_commit_hash</span><span class="o">=</span><span class="n">commit_hash</span><span class="p">,</span>
            <span class="o">**</span><span class="n">cached_file_extra_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">commit_hash</span> <span class="o">=</span> <span class="n">extract_commit_hash</span><span class="p">(</span><span class="n">resolved_vocab_files</span><span class="p">,</span> <span class="n">commit_hash</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">resolved_vocab_files</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Can&#39;t load the following file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> required for loading the tokenizer&quot;</span>
        <span class="p">)</span>

    <span class="n">tokenizer</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_fast_tokenizer</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">get_pretrained</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tokenizer</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.get_pretrained" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pretrained</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.get_pretrained" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get a pretrained tokenizer from this tokenizer</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="transformers.PreTrainedTokenizerFast">PreTrainedTokenizerFast</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Returns pre-trained fast tokenizer for hugging face models.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedTokenizerFast</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a pretrained tokenizer from this tokenizer</span>

<span class="sd">    Returns:</span>
<span class="sd">        Returns pre-trained fast tokenizer for hugging face models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;pre_tokenizer&quot;</span><span class="p">,</span> <span class="n">Whitespace</span><span class="p">()):</span>
        <span class="n">tk</span> <span class="o">=</span> <span class="n">PreTrainedTokenizerFast</span><span class="p">(</span><span class="n">tokenizer_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">tk</span><span class="o">.</span><span class="n">_tokenizer</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pre_tokenizer</span>
    <span class="c1"># now we need to add special_tokens</span>
    <span class="n">tk</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;cls_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">cls_token</span><span class="p">,</span>
            <span class="s2">&quot;bos_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token</span><span class="p">,</span>
            <span class="s2">&quot;eos_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span><span class="p">,</span>
            <span class="s2">&quot;mask_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">mask_token</span><span class="p">,</span>
            <span class="s2">&quot;pad_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span>
            <span class="s2">&quot;unk_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span><span class="p">,</span>
            <span class="s2">&quot;sep_token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">sep_token</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">model_max_length</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="n">tk</span><span class="o">.</span><span class="n">model_max_length</span> <span class="o">&gt;</span> <span class="mf">1e8</span>
        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;model_max_length&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">model_max_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span>
        <span class="nb">setattr</span><span class="p">(</span>
            <span class="n">tk</span><span class="p">,</span>
            <span class="s2">&quot;model_max_length&quot;</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;model_max_length&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">tk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.load" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Load the current tokenizer from file</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the current tokenizer from file&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">OUT</span><span class="p">:</span>
        <span class="n">data_str</span> <span class="o">=</span> <span class="n">OUT</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># EN: the rust json parser of tokenizers has a predefined structure</span>
    <span class="c1"># the next two lines are important</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.push_to_hub" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">push_to_hub</span><span class="p">(</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">use_temp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit_message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_shard_size</span><span class="o">=</span><span class="s1">&#39;10GB&#39;</span><span class="p">,</span> <span class="n">create_pr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">safe_serialization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">deprecated_kwargs</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.push_to_hub" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Upload the tokenizer to the 🤗 Model Hub.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the repository you want to push your {object} to. It should contain your organization name
when pushing to a given organization.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_temp_dir</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to use a temporary directory to store the files saved before they are pushed to the Hub.
Will default to <code>True</code> if there is no directory named like <code>repo_id</code>, <code>False</code> otherwise.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>commit_message</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message to commit while pushing. Will default to <code>"Upload {object}"</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>private</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not the repository created should be private.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token to use as HTTP bearer authorization for remote files. If <code>True</code>, will use the token generated
when running <code>huggingface-cli login</code> (stored in <code>~/.huggingface</code>). Will default to <code>True</code> if <code>repo_url</code>
is not specified.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_shard_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Only applicable for models. The maximum size for a checkpoint before being sharded. Checkpoints shard
will then be each of size lower than this size. If expressed as a string, needs to be digits followed
by a unit (like <code>"5MB"</code>).</p>
              </div>
            </td>
            <td>
                  <code>&#39;10GB&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_pr</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to create a PR with the uploaded files or directly commit.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>safe_serialization</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to convert the model weights in safetensors format for safer serialization.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">push_to_hub</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_temp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">commit_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">private</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_shard_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;10GB&quot;</span><span class="p">,</span>
    <span class="n">create_pr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">safe_serialization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">deprecated_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload the tokenizer to the 🤗 Model Hub.</span>

<span class="sd">    Args:</span>
<span class="sd">        repo_id: The name of the repository you want to push your {object} to. It should contain your organization name</span>
<span class="sd">            when pushing to a given organization.</span>
<span class="sd">        use_temp_dir: Whether or not to use a temporary directory to store the files saved before they are pushed to the Hub.</span>
<span class="sd">            Will default to `True` if there is no directory named like `repo_id`, `False` otherwise.</span>
<span class="sd">        commit_message: Message to commit while pushing. Will default to `&quot;Upload {object}&quot;`.</span>
<span class="sd">        private: Whether or not the repository created should be private.</span>
<span class="sd">        token: The token to use as HTTP bearer authorization for remote files. If `True`, will use the token generated</span>
<span class="sd">            when running `huggingface-cli login` (stored in `~/.huggingface`). Will default to `True` if `repo_url`</span>
<span class="sd">            is not specified.</span>
<span class="sd">        max_shard_size: Only applicable for models. The maximum size for a checkpoint before being sharded. Checkpoints shard</span>
<span class="sd">            will then be each of size lower than this size. If expressed as a string, needs to be digits followed</span>
<span class="sd">            by a unit (like `&quot;5MB&quot;`).</span>
<span class="sd">        create_pr: Whether or not to create a PR with the uploaded files or directly commit.</span>
<span class="sd">        safe_serialization: Whether or not to convert the model weights in safetensors format for safer serialization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">use_auth_token</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_auth_token&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_auth_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The `use_auth_token` argument is deprecated and will be removed in v5 of Transformers.&quot;</span><span class="p">,</span>
            <span class="ne">FutureWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`token` and `use_auth_token` are both specified. Please set only the argument `token`.&quot;</span>
            <span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">use_auth_token</span>

    <span class="n">repo_path_or_name</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repo_path_or_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">repo_path_or_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Should use `repo_id` instead of `repo_path_or_name`. When using `repo_path_or_name`, we try to infer</span>
        <span class="c1"># repo_id from the folder path, if it exists.</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The `repo_path_or_name` argument is deprecated and will be removed in v5 of Transformers. Use &quot;</span>
            <span class="s2">&quot;`repo_id` instead.&quot;</span><span class="p">,</span>
            <span class="ne">FutureWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">repo_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`repo_id` and `repo_path_or_name` are both specified. Please set only the argument `repo_id`.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">):</span>
            <span class="c1"># repo_path: infer repo_id from the path</span>
            <span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">working_dir</span> <span class="o">=</span> <span class="n">repo_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># repo_name: use it as repo_id</span>
            <span class="n">repo_id</span> <span class="o">=</span> <span class="n">repo_path_or_name</span>
            <span class="n">working_dir</span> <span class="o">=</span> <span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Repo_id is passed correctly: infer working_dir from it</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">repo_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Deprecation warning will be sent after for repo_url and organization</span>
    <span class="n">repo_url</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repo_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">organization</span> <span class="o">=</span> <span class="n">deprecated_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;organization&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">repo_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_repo</span><span class="p">(</span>
        <span class="n">repo_id</span><span class="p">,</span> <span class="n">private</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">repo_url</span><span class="o">=</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">organization</span><span class="o">=</span><span class="n">organization</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">use_temp_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">use_temp_dir</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">working_or_temp_dir</span><span class="p">(</span><span class="n">working_dir</span><span class="o">=</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">use_temp_dir</span><span class="o">=</span><span class="n">use_temp_dir</span><span class="p">)</span> <span class="k">as</span> <span class="n">work_dir</span><span class="p">:</span>
        <span class="n">files_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_files_timestamps</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>

        <span class="c1"># Save all files.</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span>
                <span class="n">work_dir</span><span class="p">,</span> <span class="n">max_shard_size</span><span class="o">=</span><span class="n">max_shard_size</span><span class="p">,</span> <span class="n">safe_serialization</span><span class="o">=</span><span class="n">safe_serialization</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_files_names</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_modified_files</span><span class="p">(</span>
            <span class="n">work_dir</span><span class="p">,</span>
            <span class="n">repo_id</span><span class="p">,</span>
            <span class="n">files_timestamps</span><span class="p">,</span>
            <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">create_pr</span><span class="o">=</span><span class="n">create_pr</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.save" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Saves the :class:<code>~tokenizers.Tokenizer</code> to the file at the given path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_name</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>File where to save tokenizer</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the :class:`~tokenizers.Tokenizer` to the file at the given path.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_name (str, optional): File where to save tokenizer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># EN: whole logic here assumes noone is going to mess with the special token</span>
    <span class="n">tk_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">OUT</span><span class="p">:</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tk_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">OUT</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.save_pretrained" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_pretrained</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.save_pretrained" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Save pretrained tokenizer</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save pretrained tokenizer&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.set_special_tokens" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_special_tokens</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">bos_token</span><span class="o">=</span><span class="n">CLS_TOKEN</span><span class="p">,</span> <span class="n">eos_token</span><span class="o">=</span><span class="n">SEP_TOKEN</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#safe.tokenizer.SAFETokenizer.set_special_tokens" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Set special tokens for a tokenizer</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="tokenizers.Tokenizer">Tokenizer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tokenizer for which special tokens will be set</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bos_token</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional bos token to use</p>
              </div>
            </td>
            <td>
                  <code><span title="safe.tokenizer.CLS_TOKEN">CLS_TOKEN</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eos_token</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional eos token to use</p>
              </div>
            </td>
            <td>
                  <code><span title="safe.tokenizer.SEP_TOKEN">SEP_TOKEN</span></code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">set_special_tokens</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span><span class="p">,</span>
    <span class="n">bos_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CLS_TOKEN</span><span class="p">,</span>
    <span class="n">eos_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">SEP_TOKEN</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set special tokens for a tokenizer</span>

<span class="sd">    Args:</span>
<span class="sd">        tokenizer: tokenizer for which special tokens will be set</span>
<span class="sd">        bos_token: Optional bos token to use</span>
<span class="sd">        eos_token: Optional eos token to use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">PADDING_TOKEN</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">cls_token</span> <span class="o">=</span> <span class="n">CLS_TOKEN</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">sep_token</span> <span class="o">=</span> <span class="n">SEP_TOKEN</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">mask_token</span> <span class="o">=</span> <span class="n">MASK_TOKEN</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span> <span class="o">=</span> <span class="n">UNK_TOKEN</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span> <span class="o">=</span> <span class="n">eos_token</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token</span> <span class="o">=</span> <span class="n">bos_token</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">Tokenizer</span><span class="p">):</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">PADDING_TOKEN</span><span class="p">,</span>
                <span class="n">CLS_TOKEN</span><span class="p">,</span>
                <span class="n">SEP_TOKEN</span><span class="p">,</span>
                <span class="n">MASK_TOKEN</span><span class="p">,</span>
                <span class="n">UNK_TOKEN</span><span class="p">,</span>
                <span class="n">eos_token</span><span class="p">,</span>
                <span class="n">bos_token</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">tokenizer</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.to_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.to_dict" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Convert tokenizer to dict</p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert tokenizer to dict&quot;&quot;&quot;</span>
    <span class="c1"># we need to do this because HuggingFace tokenizers doesnt save with custom pre-tokenizers</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tk_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">to_str</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">attr_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;pre_tokenizer&quot;</span><span class="p">,</span> <span class="n">Whitespace</span><span class="p">()):</span>
            <span class="c1"># temporary replace pre tokenizer with whitespace</span>
            <span class="n">tk_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">to_str</span><span class="p">())</span>
            <span class="n">tk_data</span><span class="p">[</span><span class="s2">&quot;custom_pre_tokenizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">tk_data</span><span class="p">[</span><span class="s2">&quot;tokenizer_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_type</span>
    <span class="n">tk_data</span><span class="p">[</span><span class="s2">&quot;tokenizer_attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="vm">__dict__</span>
    <span class="k">return</span> <span class="n">tk_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.train" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.train" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>This is to train a new tokenizer from either a list of file or some input data</p>
<p>Args
    files (str): file in which your molecules are separated by new line
    kwargs (dict): optional args for the tokenizer <code>train</code></p>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is to train a new tokenizer from either a list of file or some input data</span>

<span class="sd">    Args</span>
<span class="sd">        files (str): file in which your molecules are separated by new line</span>
<span class="sd">        kwargs (dict): optional args for the tokenizer `train`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">trainer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.tokenizer.SAFETokenizer.train_from_iterator" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_from_iterator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.tokenizer.SAFETokenizer.train_from_iterator" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Train the Tokenizer using the provided iterator.</p>
<p>You can provide anything that is a Python Iterator
    * A list of sequences :obj:<code>List[str]</code>
    * A generator that yields :obj:<code>str</code> or :obj:<code>List[str]</code>
    * A Numpy array of strings</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Iterator" href="https://docs.python.org/3/library/typing.html#typing.Iterator">Iterator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>data iterator</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>additional keyword argument for the tokenizer <code>train_from_iterator</code></p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/tokenizer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_from_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train the Tokenizer using the provided iterator.</span>

<span class="sd">    You can provide anything that is a Python Iterator</span>
<span class="sd">        * A list of sequences :obj:`List[str]`</span>
<span class="sd">        * A generator that yields :obj:`str` or :obj:`List[str]`</span>
<span class="sd">        * A Numpy array of strings</span>

<span class="sd">    Args:</span>
<span class="sd">        data: data iterator</span>
<span class="sd">        **kwargs: additional keyword argument for the tokenizer `train_from_iterator`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">train_from_iterator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">trainer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />
<h2 id="utils">Utils<a class="headerlink" href="#utils" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="safe.utils"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="safe.utils.MolSlicer" class="doc doc-heading">
            <code>MolSlicer</code>


<a href="#safe.utils.MolSlicer" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Slice a molecule into head-linker-tail</p>






              <details class="quote">
                <summary>Source code in <code>safe/utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MolSlicer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Slice a molecule into head-linker-tail&quot;&quot;&quot;</span>

    <span class="n">BOND_SPLITTERS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># two atoms connected by a non ring single bond, one of each is not in a ring and at least two heavy neighbor</span>
        <span class="s2">&quot;[R:1]-&amp;!@[!R;!D1:2]&quot;</span><span class="p">,</span>
        <span class="c1"># two atoms in different rings linked by a non-ring single bond</span>
        <span class="s2">&quot;[R:1]-&amp;!@[R:2]&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">_BOND_BUFFER</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># buffer around substructure match size.</span>
    <span class="n">MAX_CUTS</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># maximum number of cuts. Here we need two cuts for head-linker-tail.</span>

    <span class="n">_MERGING_RXN</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">rxn_from_smarts</span><span class="p">(</span>
        <span class="s2">&quot;[#0][*:1].[#0][*:4].([#0][*:2].[#0][*:3])&gt;&gt;([*:1][*:2].[*:3][*:4])&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shortest_linker</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">min_linker_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">require_ring_system</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor of bond slicer.</span>

<span class="sd">        Args:</span>
<span class="sd">            shortest_linker: whether to consider longuest or shortest linker.</span>
<span class="sd">                Does not have any effect when expected_head group is provided during splitting</span>
<span class="sd">            min_linker_size: minimum linker size</span>
<span class="sd">            require_ring_system: whether all fragment needs to have a ring system</span>
<span class="sd">            verbose: whether to allow verbosity in logging</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bond_splitters</span> <span class="o">=</span> <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BOND_SPLITTERS</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortest_linker</span> <span class="o">=</span> <span class="n">shortest_linker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_linker_size</span> <span class="o">=</span> <span class="n">min_linker_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_ring_system</span> <span class="o">=</span> <span class="n">require_ring_system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="k">def</span> <span class="nf">get_ring_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of ring system from a molecule</span>

<span class="sd">        Args:</span>
<span class="sd">            mol: input molecule for which we are computing the ring system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">UpdatePropertyCache</span><span class="p">()</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetRingInfo</span><span class="p">()</span>
        <span class="n">systems</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">AtomRings</span><span class="p">():</span>
            <span class="n">ring_atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
            <span class="n">cur_system</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># keep a track of ring system</span>
            <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring_atoms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">system</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ring_atoms</span> <span class="o">=</span> <span class="n">ring_atoms</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>  <span class="c1"># merge ring system that overlap</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
            <span class="n">cur_system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ring_atoms</span><span class="p">)</span>
            <span class="n">systems</span> <span class="o">=</span> <span class="n">cur_system</span>
        <span class="k">return</span> <span class="n">systems</span>

    <span class="k">def</span> <span class="nf">_bond_selection_from_max_cuts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bond_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">dist_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select bonds based on maximum number of cuts allowed&quot;&quot;&quot;</span>
        <span class="c1"># for now we are just implementing to 2 max cuts algorithms</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CUTS</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only MAX_CUTS=2 is supported, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_CUTS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">bond_pdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">bond_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bond_list</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bond_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bond_list</span><span class="p">)):</span>
                <span class="c1"># we get the minimum topological distance between bond to cut</span>
                <span class="n">bond_pdist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bond_pdist</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span> <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">bond_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bond_list</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span>
                <span class="p">)</span>

        <span class="n">masked_bond_pdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">bond_pdist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_linker_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortest_linker</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">masked_bond_pdist</span><span class="p">),</span> <span class="n">bond_pdist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">masked_bond_pdist</span><span class="p">),</span> <span class="n">bond_pdist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_bonds_to_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get possible bond to cuts</span>

<span class="sd">        Args:</span>
<span class="sd">            mol: input molecule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># use this if you want to enumerate yourself the possible cuts</span>

        <span class="n">ring_systems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ring_system</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">candidate_bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ring_query</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdqueries</span><span class="o">.</span><span class="n">IsInRingQueryAtom</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_splitters</span><span class="p">:</span>
            <span class="n">bonds</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cur_unique_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">cbond</span><span class="p">)</span> <span class="k">for</span> <span class="n">cbond</span> <span class="ow">in</span> <span class="n">candidate_bonds</span><span class="p">]</span>
            <span class="c1"># do not accept bonds part of the same ring system or already known</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
                <span class="n">bond_id</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
                <span class="n">bond_cut</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">GetMolFrags</span><span class="p">(</span>
                    <span class="n">Chem</span><span class="o">.</span><span class="n">FragmentOnBonds</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">[</span><span class="n">bond_id</span><span class="p">],</span> <span class="n">addDummies</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">asMols</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">can_add</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_ring_system</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">frag</span><span class="o">.</span><span class="n">GetAtomsMatchingQuery</span><span class="p">(</span><span class="n">ring_query</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">bond_cut</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">can_add</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cur_unique_bonds</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ring_systems</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">candidate_bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">candidate_bonds</span>

    <span class="k">def</span> <span class="nf">_fragment_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">bonds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Bond</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fragment molecules on bonds and return head, linker, tail combination</span>

<span class="sd">        Args:</span>
<span class="sd">            mol: input molecule</span>
<span class="sd">            bonds: list of bonds to cut</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdmolops</span><span class="o">.</span><span class="n">FragmentOnBonds</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">])</span>
        <span class="n">_frags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">GetMolFrags</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">asMols</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="c1"># linker is the one with 2 dummy atoms</span>
        <span class="n">linker_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">_frag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_frags</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">at</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">_frag</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">linker_pos</span> <span class="o">=</span> <span class="n">pos</span>
                <span class="k">break</span>
        <span class="n">linker</span> <span class="o">=</span> <span class="n">_frags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">linker_pos</span><span class="p">)</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">_frags</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_linker_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linker</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the score of a linker to help select between linkers&quot;&quot;&quot;</span>

        <span class="c1"># we need to take into account</span>
        <span class="c1"># case where we require the linker to have a ring system</span>
        <span class="c1"># case where we want the linker to be longuest or shortest</span>

        <span class="c1"># find shortest path</span>
        <span class="n">attach1</span><span class="p">,</span> <span class="n">attach2</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">linker</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">rdmolops</span><span class="o">.</span><span class="n">GetShortestPath</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">attach1</span><span class="p">,</span> <span class="n">attach2</span><span class="p">))</span>
        <span class="n">ring_query</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdqueries</span><span class="o">.</span><span class="n">IsInRingQueryAtom</span><span class="p">()</span>
        <span class="n">linker_ring_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">linker</span><span class="o">.</span><span class="n">GetAtomsMatchingQuery</span><span class="p">(</span><span class="n">ring_query</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_ring_system</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="n">linker_ring_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortest_linker</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">score</span>
        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">expected_head</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform slicing of the input molecule</span>

<span class="sd">        Args:</span>
<span class="sd">            mol: input molecule</span>
<span class="sd">            expected_head: substructure that should be part of the head.</span>
<span class="sd">                The small fragment containing this substructure would be kept as head</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="c1"># remove salt and solution</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">keep_largest_fragment</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdDepictor</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdmolops</span><span class="o">.</span><span class="n">GetDistanceMatrix</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">expected_head</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_head</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">expected_head</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">expected_head</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mol</span><span class="o">.</span><span class="n">HasSubstructMatch</span><span class="p">(</span><span class="n">expected_head</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Expected head was provided, but does not match molecules. It will be ignored&quot;</span>
                    <span class="p">)</span>
                <span class="n">expected_head</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">candidate_bonds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bonds_to_cut</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="c1"># we have all the candidate bonds we can cut</span>
        <span class="c1"># now we need to pick the most plausible bonds</span>
        <span class="n">selected_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidate_bonds</span><span class="p">]</span>

        <span class="c1"># CASE 1: no bond to cut ==&gt; only head</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># CASE 2: only one bond ==&gt; linker is empty</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># there is not linker</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdmolops</span><span class="o">.</span><span class="n">FragmentOnBonds</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">selected_bonds</span><span class="p">])</span>
            <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">GetMolFrags</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">asMols</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>

        <span class="c1"># CASE 3a: we select the most plausible bond to cut on ourselves</span>
        <span class="k">if</span> <span class="n">expected_head</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bond_selection_from_max_cuts</span><span class="p">(</span><span class="n">candidate_bonds</span><span class="p">,</span> <span class="n">dist_mat</span><span class="p">)</span>
            <span class="n">selected_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">selected_bonds</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">selected_bonds</span><span class="p">)</span>

        <span class="c1"># CASE 3b: slightly more complex case where we want the head to be the smallest graph containing the</span>
        <span class="c1"># provided substructure</span>
        <span class="n">bond_combination</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">selected_bonds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CUTS</span><span class="p">))</span>
        <span class="n">bond_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="n">linker_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">split_bonds</span> <span class="ow">in</span> <span class="n">bond_combination</span><span class="p">:</span>
            <span class="n">cur_head</span><span class="p">,</span> <span class="n">cur_linker</span><span class="p">,</span> <span class="n">cur_tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">split_bonds</span><span class="p">)</span>
            <span class="c1"># head can also be tail</span>
            <span class="n">head_match</span> <span class="o">=</span> <span class="n">cur_head</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">expected_head</span><span class="p">)</span>
            <span class="n">tail_match</span> <span class="o">=</span> <span class="n">cur_tail</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">expected_head</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">head_match</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tail_match</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">head_match</span> <span class="ow">and</span> <span class="n">tail_match</span><span class="p">:</span>
                <span class="n">cur_head</span><span class="p">,</span> <span class="n">cur_tail</span> <span class="o">=</span> <span class="n">cur_tail</span><span class="p">,</span> <span class="n">cur_head</span>
            <span class="n">cur_bond_score</span> <span class="o">=</span> <span class="n">cur_head</span><span class="o">.</span><span class="n">GetNumHeavyAtoms</span><span class="p">()</span>
            <span class="c1"># compute linker score</span>
            <span class="n">cur_linker_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_linker_score</span><span class="p">(</span><span class="n">cur_linker</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cur_bond_score</span> <span class="o">&lt;</span> <span class="n">bond_score</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">cur_bond_score</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BOND_BUFFER</span> <span class="o">+</span> <span class="n">bond_score</span> <span class="ow">and</span> <span class="n">cur_linker_score</span> <span class="o">&lt;</span> <span class="n">linker_score</span>
            <span class="p">):</span>
                <span class="n">head</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">cur_head</span><span class="p">,</span> <span class="n">cur_linker</span><span class="p">,</span> <span class="n">cur_tail</span>
                <span class="n">bond_score</span> <span class="o">=</span> <span class="n">cur_bond_score</span>
                <span class="n">linker_score</span> <span class="o">=</span> <span class="n">cur_linker_score</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">link_fragments</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">linker</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">head</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">tail</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Link fragments together using the provided linker</span>

<span class="sd">        Args:</span>
<span class="sd">            linker: linker to use</span>
<span class="sd">            head: head fragment</span>
<span class="sd">            tail: tail fragment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
            <span class="n">linker</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">linker</span><span class="p">)</span>
        <span class="n">linker</span> <span class="o">=</span> <span class="n">standardize_attach</span><span class="p">(</span><span class="n">linker</span><span class="p">)</span>
        <span class="n">reactants</span> <span class="o">=</span> <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">head</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">tail</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">linker</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">dm</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">apply_reaction</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_MERGING_RXN</span><span class="p">,</span> <span class="n">reactants</span><span class="p">,</span> <span class="n">as_smiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">product_index</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="safe.utils.MolSlicer.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">expected_head</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#safe.utils.MolSlicer.__call__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Perform slicing of the input molecule</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="datamol.Mol">Mol</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input molecule</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expected_head</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="datamol.Mol">Mol</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>substructure that should be part of the head.
The small fragment containing this substructure would be kept as head</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">expected_head</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform slicing of the input molecule</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: input molecule</span>
<span class="sd">        expected_head: substructure that should be part of the head.</span>
<span class="sd">            The small fragment containing this substructure would be kept as head</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="c1"># remove salt and solution</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">keep_largest_fragment</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">Chem</span><span class="o">.</span><span class="n">rdDepictor</span><span class="o">.</span><span class="n">Compute2DCoords</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdmolops</span><span class="o">.</span><span class="n">GetDistanceMatrix</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">expected_head</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_head</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">expected_head</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">expected_head</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mol</span><span class="o">.</span><span class="n">HasSubstructMatch</span><span class="p">(</span><span class="n">expected_head</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Expected head was provided, but does not match molecules. It will be ignored&quot;</span>
                <span class="p">)</span>
            <span class="n">expected_head</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">candidate_bonds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bonds_to_cut</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

    <span class="c1"># we have all the candidate bonds we can cut</span>
    <span class="c1"># now we need to pick the most plausible bonds</span>
    <span class="n">selected_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidate_bonds</span><span class="p">]</span>

    <span class="c1"># CASE 1: no bond to cut ==&gt; only head</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># CASE 2: only one bond ==&gt; linker is empty</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># there is not linker</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdmolops</span><span class="o">.</span><span class="n">FragmentOnBonds</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">selected_bonds</span><span class="p">])</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">GetMolFrags</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">asMols</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>

    <span class="c1"># CASE 3a: we select the most plausible bond to cut on ourselves</span>
    <span class="k">if</span> <span class="n">expected_head</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bond_selection_from_max_cuts</span><span class="p">(</span><span class="n">candidate_bonds</span><span class="p">,</span> <span class="n">dist_mat</span><span class="p">)</span>
        <span class="n">selected_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">selected_bonds</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">selected_bonds</span><span class="p">)</span>

    <span class="c1"># CASE 3b: slightly more complex case where we want the head to be the smallest graph containing the</span>
    <span class="c1"># provided substructure</span>
    <span class="n">bond_combination</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">selected_bonds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CUTS</span><span class="p">))</span>
    <span class="n">bond_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="n">linker_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">split_bonds</span> <span class="ow">in</span> <span class="n">bond_combination</span><span class="p">:</span>
        <span class="n">cur_head</span><span class="p">,</span> <span class="n">cur_linker</span><span class="p">,</span> <span class="n">cur_tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">split_bonds</span><span class="p">)</span>
        <span class="c1"># head can also be tail</span>
        <span class="n">head_match</span> <span class="o">=</span> <span class="n">cur_head</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">expected_head</span><span class="p">)</span>
        <span class="n">tail_match</span> <span class="o">=</span> <span class="n">cur_tail</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">expected_head</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">head_match</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tail_match</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">head_match</span> <span class="ow">and</span> <span class="n">tail_match</span><span class="p">:</span>
            <span class="n">cur_head</span><span class="p">,</span> <span class="n">cur_tail</span> <span class="o">=</span> <span class="n">cur_tail</span><span class="p">,</span> <span class="n">cur_head</span>
        <span class="n">cur_bond_score</span> <span class="o">=</span> <span class="n">cur_head</span><span class="o">.</span><span class="n">GetNumHeavyAtoms</span><span class="p">()</span>
        <span class="c1"># compute linker score</span>
        <span class="n">cur_linker_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_linker_score</span><span class="p">(</span><span class="n">cur_linker</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cur_bond_score</span> <span class="o">&lt;</span> <span class="n">bond_score</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">cur_bond_score</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BOND_BUFFER</span> <span class="o">+</span> <span class="n">bond_score</span> <span class="ow">and</span> <span class="n">cur_linker_score</span> <span class="o">&lt;</span> <span class="n">linker_score</span>
        <span class="p">):</span>
            <span class="n">head</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">cur_head</span><span class="p">,</span> <span class="n">cur_linker</span><span class="p">,</span> <span class="n">cur_tail</span>
            <span class="n">bond_score</span> <span class="o">=</span> <span class="n">cur_bond_score</span>
            <span class="n">linker_score</span> <span class="o">=</span> <span class="n">cur_linker_score</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.utils.MolSlicer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">shortest_linker</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_linker_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">require_ring_system</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#safe.utils.MolSlicer.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Constructor of bond slicer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>shortest_linker</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to consider longuest or shortest linker.
Does not have any effect when expected_head group is provided during splitting</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_linker_size</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>minimum linker size</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_ring_system</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether all fragment needs to have a ring system</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to allow verbosity in logging</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">shortest_linker</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">min_linker_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">require_ring_system</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructor of bond slicer.</span>

<span class="sd">    Args:</span>
<span class="sd">        shortest_linker: whether to consider longuest or shortest linker.</span>
<span class="sd">            Does not have any effect when expected_head group is provided during splitting</span>
<span class="sd">        min_linker_size: minimum linker size</span>
<span class="sd">        require_ring_system: whether all fragment needs to have a ring system</span>
<span class="sd">        verbose: whether to allow verbosity in logging</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bond_splitters</span> <span class="o">=</span> <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BOND_SPLITTERS</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shortest_linker</span> <span class="o">=</span> <span class="n">shortest_linker</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_linker_size</span> <span class="o">=</span> <span class="n">min_linker_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">require_ring_system</span> <span class="o">=</span> <span class="n">require_ring_system</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.utils.MolSlicer.get_ring_system" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_ring_system</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span></code>

<a href="#safe.utils.MolSlicer.get_ring_system" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the list of ring system from a molecule</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><span title="datamol.Mol">Mol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input molecule for which we are computing the ring system</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_ring_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the list of ring system from a molecule</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: input molecule for which we are computing the ring system</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">UpdatePropertyCache</span><span class="p">()</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetRingInfo</span><span class="p">()</span>
    <span class="n">systems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">ri</span><span class="o">.</span><span class="n">AtomRings</span><span class="p">():</span>
        <span class="n">ring_atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="n">cur_system</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># keep a track of ring system</span>
        <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring_atoms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">system</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ring_atoms</span> <span class="o">=</span> <span class="n">ring_atoms</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>  <span class="c1"># merge ring system that overlap</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur_system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="n">cur_system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ring_atoms</span><span class="p">)</span>
        <span class="n">systems</span> <span class="o">=</span> <span class="n">cur_system</span>
    <span class="k">return</span> <span class="n">systems</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="safe.utils.MolSlicer.link_fragments" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">link_fragments</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#safe.utils.MolSlicer.link_fragments" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Link fragments together using the provided linker</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>linker</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="datamol.Mol">Mol</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>linker to use</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>head</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="datamol.Mol">Mol</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>head fragment</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tail</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<span title="datamol.Mol">Mol</span>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tail fragment</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">link_fragments</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">linker</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">head</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">tail</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Link fragments together using the provided linker</span>

<span class="sd">    Args:</span>
<span class="sd">        linker: linker to use</span>
<span class="sd">        head: head fragment</span>
<span class="sd">        tail: tail fragment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
        <span class="n">linker</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">linker</span><span class="p">)</span>
    <span class="n">linker</span> <span class="o">=</span> <span class="n">standardize_attach</span><span class="p">(</span><span class="n">linker</span><span class="p">)</span>
    <span class="n">reactants</span> <span class="o">=</span> <span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">head</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">tail</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">linker</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">dm</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">apply_reaction</span><span class="p">(</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_MERGING_RXN</span><span class="p">,</span> <span class="n">reactants</span><span class="p">,</span> <span class="n">as_smiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">product_index</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="safe.utils.attr_as" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">attr_as</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

<a href="#safe.utils.attr_as" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Temporary replace the value of an object</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>obj</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>object to temporary patch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>field</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the key to change</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>value of key to be temporary changed</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">attr_as</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Temporary replace the value of an object</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: object to temporary patch</span>
<span class="sd">        field: name of the key to change</span>
<span class="sd">        value: value of key to be temporary changed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">old_value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.utils.compute_side_chains" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_side_chains</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">label_by_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#safe.utils.compute_side_chains" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute the side chain of a molecule given a core</p>
<div class="admonition note">
<p class="admonition-title">Finding the side chains</p>
<p>The algorithm to find the side chains from core assumes that the core we get as input has attachment points.
Those attachment points are never considered as part of the query, rather they are used to define the attachment points
on the side chains. Removing the attachment points from the core is exactly the same as keeping them.</p>
<p><div class="highlight"><pre><span></span><code><span class="n">mol</span> <span class="o">=</span> <span class="s2">&quot;CC1=C(C(=NO1)C2=CC=CC=C2Cl)C(=O)NC3C4N(C3=O)C(C(S4)(C)C)C(=O)O&quot;</span>
<span class="n">core0</span> <span class="o">=</span> <span class="s2">&quot;CC1(C)CN2C(CC2=O)S1&quot;</span>
<span class="n">core1</span> <span class="o">=</span> <span class="s2">&quot;CC1(C)SC2C(-*)C(=O)N2C1-*&quot;</span>
<span class="n">core2</span> <span class="o">=</span> <span class="s2">&quot;CC1N2C(SC1(C)C)C(N)C2=O&quot;</span>
<span class="n">side_chain</span> <span class="o">=</span> <span class="n">compute_side_chain</span><span class="p">(</span><span class="n">core</span><span class="o">=</span><span class="n">core0</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">)</span>
<span class="n">dm</span><span class="o">.</span><span class="n">to_image</span><span class="p">([</span><span class="n">side_chain</span><span class="p">,</span> <span class="n">core0</span><span class="p">,</span> <span class="n">mol</span><span class="p">])</span>
</code></pre></div>
Therefore on the above, core0 and core1 are equivalent for the molecule <code>mol</code>, but core2 is not.</p>
</div>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><span title="datamol.Mol">Mol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>molecule to split</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>core</code>
            </td>
            <td>
                  <code><span title="datamol.Mol">Mol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>core to use for deriving the side chains</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_side_chains</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">core</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">label_by_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the side chain of a molecule given a core</span>

<span class="sd">    !!! note &quot;Finding the side chains&quot;</span>
<span class="sd">        The algorithm to find the side chains from core assumes that the core we get as input has attachment points.</span>
<span class="sd">        Those attachment points are never considered as part of the query, rather they are used to define the attachment points</span>
<span class="sd">        on the side chains. Removing the attachment points from the core is exactly the same as keeping them.</span>

<span class="sd">        ```python</span>
<span class="sd">        mol = &quot;CC1=C(C(=NO1)C2=CC=CC=C2Cl)C(=O)NC3C4N(C3=O)C(C(S4)(C)C)C(=O)O&quot;</span>
<span class="sd">        core0 = &quot;CC1(C)CN2C(CC2=O)S1&quot;</span>
<span class="sd">        core1 = &quot;CC1(C)SC2C(-*)C(=O)N2C1-*&quot;</span>
<span class="sd">        core2 = &quot;CC1N2C(SC1(C)C)C(N)C2=O&quot;</span>
<span class="sd">        side_chain = compute_side_chain(core=core0, mol=mol)</span>
<span class="sd">        dm.to_image([side_chain, core0, mol])</span>
<span class="sd">        ```</span>
<span class="sd">        Therefore on the above, core0 and core1 are equivalent for the molecule `mol`, but core2 is not.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: molecule to split</span>
<span class="sd">        core: core to use for deriving the side chains</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">core</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">core</span><span class="p">)</span>
    <span class="n">core_query_param</span> <span class="o">=</span> <span class="n">AdjustQueryParameters</span><span class="p">()</span>
    <span class="n">core_query_param</span><span class="o">.</span><span class="n">makeDummiesQueries</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">core_query_param</span><span class="o">.</span><span class="n">adjustDegree</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">core_query_param</span><span class="o">.</span><span class="n">aromatizeIfPossible</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">core_query_param</span><span class="o">.</span><span class="n">makeBondsGeneric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">core_query</span> <span class="o">=</span> <span class="n">AdjustQueryProperties</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">core_query_param</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ReplaceCore</span><span class="p">(</span>
        <span class="n">mol</span><span class="p">,</span> <span class="n">core_query</span><span class="p">,</span> <span class="n">labelByIndex</span><span class="o">=</span><span class="n">label_by_index</span><span class="p">,</span> <span class="n">replaceDummies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">requireDummyMatch</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.utils.convert_to_safe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert_to_safe</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">slicer</span><span class="o">=</span><span class="s1">&#39;brics&#39;</span><span class="p">,</span> <span class="n">split_fragment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fraction_hs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

<a href="#safe.utils.convert_to_safe" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a molecule to a safe representation</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><span title="datamol.Mol">Mol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>molecule to convert</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>canonical</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to use canonical encoding</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>randomize</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to randomize the encoding</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random seed</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slicer</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the slicer to use for fragmentation</p>
              </div>
            </td>
            <td>
                  <code>&#39;brics&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>split_fragment</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to split fragments</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fraction_hs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>proportion of random atom to which we will add explicit hydrogens</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>resolution for the partitioning algorithm</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random seed</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">convert_to_safe</span><span class="p">(</span>
    <span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span>
    <span class="n">canonical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">randomize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">slicer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;brics&quot;</span><span class="p">,</span>
    <span class="n">split_fragment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">fraction_hs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a molecule to a safe representation</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: molecule to convert</span>
<span class="sd">        canonical: whether to use canonical encoding</span>
<span class="sd">        randomize: whether to randomize the encoding</span>
<span class="sd">        seed: random seed</span>
<span class="sd">        slicer: the slicer to use for fragmentation</span>
<span class="sd">        split_fragment: whether to split fragments</span>
<span class="sd">        fraction_hs: proportion of random atom to which we will add explicit hydrogens</span>
<span class="sd">        resolution: resolution for the partitioning algorithm</span>
<span class="sd">        seed: random seed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="n">canonical</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="n">randomize</span><span class="p">,</span> <span class="n">slicer</span><span class="o">=</span><span class="n">slicer</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sf</span><span class="o">.</span><span class="n">SAFEFragmentationError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">split_fragment</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">mol</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">mol</span><span class="p">,</span>
                    <span class="n">canonical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">randomize</span><span class="o">=</span><span class="n">randomize</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                    <span class="n">slicer</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span>
                        <span class="n">fragment_aware_spliting</span><span class="p">,</span>
                        <span class="n">fraction_hs</span><span class="o">=</span><span class="n">fraction_hs</span><span class="p">,</span>
                        <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">SAFEEncodeError</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">SAFEFragmentationError</span><span class="p">):</span>
                <span class="c1"># logger.exception(e)</span>
                <span class="k">return</span> <span class="n">x</span>
        <span class="c1"># we need to resplit using attachment point but here we are only adding</span>
    <span class="k">except</span> <span class="n">sf</span><span class="o">.</span><span class="n">SAFEEncodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.utils.filter_by_substructure_constraints" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">filter_by_substructure_constraints</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">substruct</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#safe.utils.filter_by_substructure_constraints" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Check whether the input substructures are present in each of the molecule in the sequences</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sequences</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of molecules to validate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>substruct</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>substructure to use as query</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_jobs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of jobs to use for parallelization</p>
              </div>
            </td>
            <td>
                  <code>-1</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_by_substructure_constraints</span><span class="p">(</span>
    <span class="n">sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">]],</span> <span class="n">substruct</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">],</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check whether the input substructures are present in each of the molecule in the sequences</span>

<span class="sd">    Args:</span>
<span class="sd">        sequences: list of molecules to validate</span>
<span class="sd">        substruct: substructure to use as query</span>
<span class="sd">        n_jobs: number of jobs to use for parallelization</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substruct</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">substruct</span> <span class="o">=</span> <span class="n">standardize_attach</span><span class="p">(</span><span class="n">substruct</span><span class="p">)</span>
        <span class="n">substruct</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="n">substruct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_match</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mol</span><span class="o">.</span><span class="n">HasSubstructMatch</span><span class="p">(</span><span class="n">substruct</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">matches</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">parallelized</span><span class="p">(</span><span class="n">_check_match</span><span class="p">,</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">matches</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.utils.find_partition_edges" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_partition_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">partition</span><span class="p">)</span></code>

<a href="#safe.utils.find_partition_edges" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Find the edges connecting the subgraphs in a given partition of a graph.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>G</code>
            </td>
            <td>
                  <code><span title="networkx.Graph">Graph</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition</code>
            </td>
            <td>
                  <code>list of list of nodes</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The partition of the graph where each element is a list of nodes representing a subgraph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of edges connecting the subgraphs in the partition.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">find_partition_edges</span><span class="p">(</span><span class="n">G</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">partition</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the edges connecting the subgraphs in a given partition of a graph.</span>

<span class="sd">    Args:</span>
<span class="sd">        G (networkx.Graph): The original graph.</span>
<span class="sd">        partition (list of list of nodes): The partition of the graph where each element is a list of nodes representing a subgraph.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of edges connecting the subgraphs in the partition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">partition_edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subgraph1</span><span class="p">,</span> <span class="n">subgraph2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">partition</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">edge_boundary</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">subgraph1</span><span class="p">,</span> <span class="n">subgraph2</span><span class="p">)</span>
        <span class="n">partition_edges</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">partition_edges</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.utils.fragment_aware_spliting" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fragment_aware_spliting</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">fraction_hs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.utils.fragment_aware_spliting" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Custom splitting algorithm for dataset building.</p>
<p>This slicing strategy will cut any bond including bonding with hydrogens
However, only one cut per atom is allowed</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><span title="datamol.Mol">Mol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>molecule to split</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fraction_hs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>proportion of random atom to which we will add explicit hydrogens</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>additional arguments to pass to the partitioning algorithm</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fragment_aware_spliting</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">fraction_hs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom splitting algorithm for dataset building.</span>

<span class="sd">    This slicing strategy will cut any bond including bonding with hydrogens</span>
<span class="sd">    However, only one cut per atom is allowed</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: molecule to split</span>
<span class="sd">        fraction_hs: proportion of random atom to which we will add explicit hydrogens</span>
<span class="sd">        kwargs: additional arguments to pass to the partitioning algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">remove_hs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">_selective_add_hs</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">fraction_hs</span><span class="o">=</span><span class="n">fraction_hs</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">to_graph</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">mol_partition</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">partition</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">find_partition_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">partition</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.utils.list_individual_attach_points" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_individual_attach_points</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#safe.utils.list_individual_attach_points" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>List all individual attachement points.</p>
<p>We do not allow multiple attachment points per substitution position.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><span title="datamol.Mol">Mol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>molecule for which we need to open the attachment points</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">list_individual_attach_points</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all individual attachement points.</span>

<span class="sd">    We do not allow multiple attachment points per substitution position.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: molecule for which we need to open the attachment points</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ATTACHING_RXN</span> <span class="o">=</span> <span class="n">ReactionFromSmarts</span><span class="p">(</span><span class="s2">&quot;[*;h;!$([*][#0]):1]&gt;&gt;[*:1][*]&quot;</span><span class="p">)</span>
    <span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span><span class="p">]</span>
    <span class="n">curated_prods</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">num_attachs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">from_smarts</span><span class="p">(</span><span class="s2">&quot;[*;h:1]&quot;</span><span class="p">),</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">num_attachs</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">prods</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mols</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ATTACHING_RXN</span><span class="o">.</span><span class="n">RunReactants</span><span class="p">((</span><span class="n">mol</span><span class="p">,)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">sanitize_mol</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">sm</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">sm</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">add_brackets_to_attachment_points</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>
                    <span class="n">prods</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">convert_attach_to_isotope</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">as_smiles</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">curated_prods</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prods</span><span class="p">)</span>
        <span class="n">mols</span> <span class="o">=</span> <span class="n">prods</span>
        <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">curated_prods</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.utils.mol_partition" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mol_partition</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#safe.utils.mol_partition" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Partition a molecule into fragments using a bond query</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mol</code>
            </td>
            <td>
                  <code><span title="datamol.Mol">Mol</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>molecule to split</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<span title="datamol.Mol">Mol</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bond query to use for splitting</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random seed</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>additional arguments to pass to the partitioning algorithm</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@py_random_state</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mol_partition</span><span class="p">(</span>
    <span class="n">mol</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dm</span><span class="o">.</span><span class="n">Mol</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Partition a molecule into fragments using a bond query</span>

<span class="sd">    Args:</span>
<span class="sd">        mol: molecule to split</span>
<span class="sd">        query: bond query to use for splitting</span>
<span class="sd">        seed: random seed</span>
<span class="sd">        kwargs: additional arguments to pass to the partitioning algorithm</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="mf">1e-7</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">__mmpa_query</span>

    <span class="n">G</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">to_graph</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">bond_partition</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">match</span><span class="p">))</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">uniquify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_relevant_edges</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">]))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bond_partition</span>

    <span class="n">subgraphs</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">subgraph_view</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">filter_edge</span><span class="o">=</span><span class="n">get_relevant_edges</span><span class="p">)</span>

    <span class="n">partition</span> <span class="o">=</span> <span class="p">[{</span><span class="n">u</span><span class="p">}</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()]</span>
    <span class="n">inner_partition</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">subgraphs</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">modularity</span><span class="p">(</span>
        <span class="n">G</span><span class="p">,</span> <span class="n">inner_partition</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span>
    <span class="p">)</span>
    <span class="n">is_directed</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">is_directed</span><span class="p">()</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_weighted_edges_from</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">louvain</span><span class="o">.</span><span class="n">_gen_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">inner_partition</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
    <span class="n">partition</span><span class="p">,</span> <span class="n">inner_partition</span><span class="p">,</span> <span class="n">improvement</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">louvain</span><span class="o">.</span><span class="n">_one_level</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">inner_partition</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">is_directed</span><span class="p">,</span> <span class="n">seed</span>
    <span class="p">)</span>
    <span class="n">improvement</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">improvement</span><span class="p">:</span>
        <span class="c1"># gh-5901 protect the sets in the yielded list from further manipulation here</span>
        <span class="k">yield</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">partition</span><span class="p">]</span>
        <span class="n">new_mod</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">modularity</span><span class="p">(</span>
            <span class="n">graph</span><span class="p">,</span> <span class="n">inner_partition</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">new_mod</span> <span class="o">-</span> <span class="n">mod</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">new_mod</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">louvain</span><span class="o">.</span><span class="n">_gen_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">inner_partition</span><span class="p">)</span>
        <span class="n">partition</span><span class="p">,</span> <span class="n">inner_partition</span><span class="p">,</span> <span class="n">improvement</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">louvain</span><span class="o">.</span><span class="n">_one_level</span><span class="p">(</span>
            <span class="n">graph</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">partition</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">is_directed</span><span class="p">,</span> <span class="n">seed</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="safe.utils.standardize_attach" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">standardize_attach</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">standard_attach</span><span class="o">=</span><span class="s1">&#39;[*]&#39;</span><span class="p">)</span></code>

<a href="#safe.utils.standardize_attach" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Standardize the attachment points of a molecule</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>input molecule</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>standard_attach</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>standard attachment point to use</p>
              </div>
            </td>
            <td>
                  <code>&#39;[*]&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>safe/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">standardize_attach</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">standard_attach</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;[*]&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standardize the attachment points of a molecule</span>

<span class="sd">    Args:</span>
<span class="sd">        inputs: input molecule</span>
<span class="sd">        standard_attach: standard attachment point to use</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">attach_regex</span> <span class="ow">in</span> <span class="n">_SMILES_ATTACHMENT_POINTS</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">attach_regex</span><span class="p">,</span> <span class="n">standard_attach</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inputs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright 2023 Valence Labs
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/datamol-io" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/datamol_io" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/safe-mol/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.expand"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
        <script src="../assets/js/google-analytics.js"></script>
      
    
  </body>
</html>